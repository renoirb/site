__NUXT_JSONP__("/blog/tag/salt-stack", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa,ab,ac,ad,ae,af,ag,ah,ai,aj,ak,al,am,an,ao,ap,aq,ar,as,at,au,av,aw,ax,ay,az,aA,aB,aC,aD,aE,aF,aG,aH,aI,aJ,aK,aL,aM,aN,aO,aP,aQ,aR,aS,aT,aU,aV,aW,aX,aY,aZ,a_,a$,ba,bb,bc,bd,be,bf,bg,bh,bi,bj,bk,bl,bm,bn,bo,bp,bq,br,bs,bt,bu,bv,bw,bx,by,bz,bA,bB,bC,bD,bE,bF,bG,bH,bI,bJ,bK,bL,bM,bN,bO,bP,bQ,bR,bS,bT,bU,bV,bW,bX,bY,bZ,b_,b$,ca,cb,cc,cd,ce,cf,cg,ch,ci,cj,ck,cl,cm,cn,co,cp,cq,cr,cs,ct,cu,cv,cw,cx,cy,cz,cA,cB,cC,cD,cE,cF,cG,cH,cI,cJ,cK,cL,cM,cN,cO,cP,cQ,cR,cS,cT,cU,cV,cW,cX,cY,cZ,c_,c$,da,db,dc,dd,de,df,dg,dh,di,dj,dk,dl,dm,dn,do0,dp,dq,dr,ds,dt,du,dv,dw,dx,dy,dz,dA,dB,dC,dD,dE,dF,dG,dH,dI,dJ,dK,dL,dM,dN,dO,dP,dQ,dR,dS,dT,dU,dV,dW,dX,dY,dZ,d_,d$,ea,eb,ec,ed,ee,ef,eg,eh,ei,ej,ek,el,em,en,eo){return {data:[{},{},{contents:[{title:"Add OpenStack instance meta-data info in your salt grains",locale:ar,created:"2015-05-22T00:00:00.000Z",updated:"2023-11-17T00:00:00.000Z",canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F05\u002Fadd-openstack-instance-meta-data-info-salt-grains\u002F",status:aj,revising:B,migrateLinks:O,migrateImages:B,gallery:B,caption:B,categories:[aN],tags:[aH,bd,ab,as,"open-source"],keywords:["Ansible","Infrastructure as Code"],preamble:{text:"It is possible the code shown here no longer works.\nThis was written at the time before VMWare aquired SaltStack and maybe\ncode shown uses parts of Salt Stack that no longer exists.\n"},coverImage:{src:bC,alt:"A terminal window showing Open Stack nova client output",text:"Open Stack NOVA client is leveraging an internal HTTP API to display data we can\nconsume from the CLI.\nThe present article shows how to add data from OpenStack into Salt Stack.\n"},excerpt:"Ever wanted to target salt states based on data only the underlying OpenStack cluster knows. Here’s how I did it.",toc:[{id:bD,depth:Q,text:bE},{id:bF,depth:Q,text:bG},{id:bH,depth:Q,text:bI},{id:bJ,depth:Q,text:bK}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"During a work session on my salt-states for WebPlatform.org I wanted to shape be\nable to query the OpenStack cluster meta-data so that I can adjust more\nefficiently my salt configuration."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"What are grains? Grains are structured data that describes what a minion has\nsuch as which version of GNU\u002FLinux its running, what are the network adapters,\netc."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The following is a Python script that adds data in Salt Stack' internal database\ncalled grains."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"I have to confess that I didn't write the script but adapted it to work within\nan OpenStack cluster. More precisely on DreamHost's DreamCompute cluster. The\noriginal script came from "},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fsaltstack\u002Fsalt-contrib",rel:[p,q,r],target:s},children:[{type:a,value:"saltstack\u002Fsalt-contrib"}]},{type:a,value:" and the original file was\n"},{type:b,tag:n,props:{href:bL,rel:[p,q,r],target:s},children:[{type:a,value:"ec2_info.py"}]},{type:a,value:" to read data from EC2."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:bM},{type:b,tag:n,props:{href:bL,rel:[p,q,r],target:s},children:[{type:a,value:"original script"}]},{type:a,value:" wasn't getting any data in the cluster. Most likely due\nto API changes and that EC2 API exposes dynamic meta-data that the\nDreamCompute\u002FOpenStack cluster don't."}]},{type:a,value:e},{type:b,tag:"rb-notice-box",props:{variant:"info",className:["my-5"]},children:[{type:a,value:e},{type:b,tag:M,props:{slot:"header"},children:[{type:a,value:"Script source"}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The article’s source script is available on GitHub as a Python script we can\ninsert into SaltStack as a grain"}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fsalt-states\u002Fblob\u002Fmaster\u002F_grains\u002Fdreamcompute.py",rel:[p,q,r],target:s},children:[{type:a,value:"github.com\u002Fwebplatform\u002Fsalt-states"}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"In the end, I edited the file to make it work on DreamCompute and also truncated\nsome data that the grains subsystem already has."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"My original objective was to get a list of "},{type:b,tag:i,props:{},children:[{type:a,value:bN}]},{type:a,value:" the VM was\nassigned. Unfortunately the API doesn't give that information yet. Hopefully\nI'll find a way to get that information some day."}]},{type:a,value:e},{type:b,tag:X,props:{id:bD},children:[{type:b,tag:n,props:{href:"#get-openstack-instance-detail-using-salt",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:bE}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Locally"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt-call grains.get dreamcompute:uuid\n"}]}]}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"local"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n    10a4f390"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bO},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bP},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:be},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bQ}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Or for another machine"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt app1 grains.get dreamcompute:uuid\n"}]}]}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bR}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n    510f5f24"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"217b"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"4fd2"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:be},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"f00000000000\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"What size did we create a particular VM?"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt app1 grains.get dreamcompute:instance_type\n"}]}]}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bR}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n    lightspeed\n"}]}]}]},{type:a,value:e},{type:b,tag:X,props:{id:bF},children:[{type:b,tag:n,props:{href:"#what-data-you-can-get",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:bG}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Here is a sample of the grain data that will be added to every salt minion you\nmanage."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"You might notice that some data will be repeated such as the 'hostname', but the\nrest can be very useful if you want to use the data within your configuration\nmanag"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"dreamcompute"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bS}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        iad"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:bf}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"block_device_mapping"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"ami"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:bT},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"ebs0"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n            \u002Fdev\u002Fvdb\n        "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"ebs1"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:bT},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:ae}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n            \u002Fdev\u002Fvda\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"hostname"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        salt.novalocal\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"instance_action"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        none\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"instance_id"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        i"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:"00000000"}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"instance_type"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        lightspeed\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"launch_index"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:bU}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"local_ipv4"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        10.10.10.11\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        salt\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"network_config"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"content_path"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n            \u002Fcontent\u002F0000\n        "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n            network_config\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"placement"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bS}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n            iad"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:bf}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"public_ipv4"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        203.0.113.11\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"public_keys"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:V}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"someuser"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n            ssh"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"rsa "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:bV}]},{type:a,value:"an rsa public key"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:bV}]},{type:a,value:" someuser"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"comment@example.org\n    "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"ramdisk_id"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:bW},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"reservation_id"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        r"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:"33333333"}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bN}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:bW},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"uuid"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\n        10a4f390"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bO},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bP},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:be},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bQ}]}]}]},{type:a,value:e},{type:b,tag:X,props:{id:bH},children:[{type:b,tag:n,props:{href:"#what-does-the-script-do",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:bI}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The script basically scrapes OpenStack meta-data service and serializes into\nsaltstack grains system the data it gets."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:n,props:{href:bX,rel:[p,q,r],target:s},children:[{type:a,value:"OpenStack's meta-data service"}]},{type:a,value:" is similar to what you'd get from AWS, but\ndoesn't expose exactly the same data. This is why I had to adapt the original\nscript."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"To get data from an instance you simply (really!) need to make an HTTP call to\nan "},{type:b,tag:n,props:{href:bX,rel:[p,q,r],target:s},children:[{type:a,value:"internal IP address that OpenStack nova"}]},{type:a,value:" answers. (that’s what the IPv4\naddress starting by "},{type:b,tag:i,props:{},children:[{type:a,value:"169."}]},{type:a,value:" is)"}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"For example, from an AWS\u002FOpenStack VM, you can know the instance hostname by\ndoing"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:bg}]},{type:a,value:" http:\u002F\u002F169.254.169.254\u002Flatest\u002Fmeta-data\u002Fhostname\n\nsalt.novalocal\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"To know what the script calls, "},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fsalt-states\u002Fcommit\u002F821ca803#diff-6eea2056af3e939361a559b84665c1d97fc9e062f7b7f79910567fc688881056R33",rel:[p,q,r],target:s},children:[{type:a,value:"you can add a line at "},{type:b,tag:i,props:{},children:[{type:a,value:"_call_aws(url)"}]},{type:a,value:"\nmethod"}]},{type:a,value:bY},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fsalt-states\u002Fcommit\u002F821ca803#diff-6eea2056af3e939361a559b84665c1d97fc9e062f7b7f79910567fc688881056R32-R34",rel:[p,q,r],target:s},children:[{type:a,value:"lines 32-34"}]},{type:a,value:"), like so;"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,"language-diff"]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"diff --git a\u002F_grains\u002Fdreamcompute.py b\u002F_grains\u002Fdreamcompute.py\nindex 682235d..c3af659 100644\n"},{type:b,tag:c,props:{className:[d,bZ]},children:[{type:a,value:"--- a\u002F_grains\u002Fdreamcompute.py"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,bZ]},children:[{type:a,value:"+++ b\u002F_grains\u002Fdreamcompute.py"}]},{type:a,value:"\n@@ -25,6 +25,7 @@ def _call_aws(url):\n\n"},{type:b,tag:c,props:{className:[d,ax]},children:[{type:b,tag:c,props:{className:[d,aI,ax]},children:[{type:a,value:o}]},{type:b,tag:c,props:{className:[d,aJ]},children:[{type:a,value:"    \"\"\"\n"}]},{type:b,tag:c,props:{className:[d,aI,ax]},children:[{type:a,value:o}]},{type:b,tag:c,props:{className:[d,aJ]},children:[{type:a,value:"    conn = httplib.HTTPConnection(\"169.254.169.254\", 80, timeout=1)\n"}]}]},{type:b,tag:c,props:{className:[d,"inserted-sign",b_]},children:[{type:b,tag:c,props:{className:[d,aI,b_]},children:[{type:a,value:"+"}]},{type:b,tag:c,props:{className:[d,aJ]},children:[{type:a,value:"    LOG.info('API call to ' + url )\n"}]}]},{type:b,tag:c,props:{className:[d,ax]},children:[{type:b,tag:c,props:{className:[d,aI,ax]},children:[{type:a,value:o}]},{type:b,tag:c,props:{className:[d,aJ]},children:[{type:a,value:"    conn.request('GET', url)\n"}]},{type:b,tag:c,props:{className:[d,aI,ax]},children:[{type:a,value:o}]},{type:b,tag:c,props:{className:[d,aJ]},children:[{type:a,value:"    return conn.getresponse()\n"}]}]}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"When you "},{type:b,tag:i,props:{},children:[{type:a,value:"saltutil.sync_all"}]},{type:a,value:" (i.e. refresh grains and other data), the log will\ntell you which endpoints it queried."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"In my case they were:"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,"language-shellsession"]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,"output"]},children:[{type:a,value:"[INFO    ] API call to \u002Fopenstack\u002F2012-08-10\u002Fmeta_data.json\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002F\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002F\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Fami\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Febs0\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Febs1\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Froot\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fhostname\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Finstance-action\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Finstance-id\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Finstance-type\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Flocal-ipv4\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fplacement\u002F\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fplacement\u002Favailability-zone\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fpublic-ipv4\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Framdisk-id\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Freservation-id\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fsecurity-groups\n[INFO    ] API call to \u002Fopenstack\u002F2012-08-10\u002Fmeta_data.json\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002F\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002F\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Fami\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Febs0\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Febs1\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fblock-device-mapping\u002Froot\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fhostname\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Finstance-action\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Finstance-id\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Finstance-type\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Flocal-ipv4\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fplacement\u002F\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fplacement\u002Favailability-zone\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fpublic-ipv4\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Framdisk-id\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Freservation-id\n[INFO    ] API call to \u002Flatest\u002Fmeta-data\u002Fsecurity-groups\n"}]}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Its quite heavy."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Hopefully the script respects HTTP headers and don't bypass "},{type:b,tag:i,props:{},children:[{type:a,value:"304 Not Modified"}]},{type:a,value:"\nresponses. Otherwise it'll add load to nova. Maybe I should check that\n(note-to-self)."}]},{type:a,value:e},{type:b,tag:X,props:{id:bJ},children:[{type:b,tag:n,props:{href:"#install",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:bK}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"You can add this feature by adding a file in your salt states repository in the\n"},{type:b,tag:i,props:{},children:[{type:a,value:"_grains\u002F"}]},{type:a,value:" folder. The file can have any name ending by "},{type:b,tag:i,props:{},children:[{type:a,value:".py"}]},{type:a,value:ak}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"You can grab the grain python code "},{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002F6b26b67321fe15870aa0",rel:[p,q,r],target:s,title:"Gist where you can add openstack meta-data in your grains"},children:[{type:a,value:"in this gist"}]},{type:a,value:ak}]},{type:a,value:e},{type:a,value:e},{type:a,value:e}]},dir:"\u002Fblog\u002F2015\u002F05",path:"\u002Fblog\u002F2015\u002F05\u002Fadd-openstack-instance-meta-data-info-salt-grains",extension:al,slug:"add-openstack-instance-meta-data-info-salt-grains",createdAt:b$,updatedAt:b$,category:aN,prettyfiedTemporalDate:{prettified:"Friday, May 22, 2015",temporalDate:"2015-05-22"}},{title:"Install Discourse and Docker on Ubuntu 14.04 with aufs enabled",locale:ar,created:"2015-04-02T00:00:00.000Z",updated:bh,canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F04\u002Finstall-discourse-docker-ubuntu-14-04-aufs-enabled\u002F",status:aj,revising:O,categories:[am],tags:["standardization",ab,aK],keywords:[ca,"discourse",bi,"ubuntu","makefile"],excerpt:"I needed to install a set of VMs to run apps within Docker containers. In the case of Discourse, docker requires you to use aufs instead of devicemapper.",toc:[{id:aK,depth:Q,text:ay}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"While working to run "},{type:b,tag:n,props:{href:"https:\u002F\u002Fwww.discourse.org\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"Discourse"}]},{type:a,value:" on "},{type:b,tag:n,props:{href:"https:\u002F\u002Fwww.docker.com\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"Docker"}]},{type:a,value:" I was getting numerous errors\nabout a mount problem related to device mapper."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"If you are using Ubuntu 14.04 LTS, want to solve the problem with aufs, and use\nSalt Stack to control your VMs, here's how I did it."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"After digging "},{type:b,tag:n,props:{href:"https:\u002F\u002Fmeta.discourse.org\u002Ft\u002Fdocker-error-on-bootstrap\u002F13657\u002F9",rel:[p,q,r],target:s},children:[{type:a,value:"for"}]},{type:a,value:o},{type:b,tag:n,props:{href:"https:\u002F\u002Fmeta.discourse.org\u002Ft\u002Fubuntu-updates-intefere-with-docker-and-aufs\u002F25039",rel:[p,q,r],target:s},children:[{type:a,value:"some"}]},{type:a,value:" time, I found others who had also problems to\nrun Discourse in Docker, and that we had to use \"aufs\"."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"I had no idea that we could use different mount subsystems in Docker."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"So I had to read some more on we can find out if we have "},{type:b,tag:i,props:{},children:[{type:a,value:bi}]},{type:a,value:" (whatever this\nis), and that we can tell whether or not Docker is configured to use it."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:bM},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdocker\u002Fissues\u002F10161",rel:[p,q,r],target:s},children:[{type:a,value:"issue docker\u002Fdocker#10161"}]},{type:a,value:" had proven very helpful to figure out what\nwas my problem. I never thought I could tell Docker to use another device mapper\nengine anyway. In the end, all you can do is to add a "},{type:b,tag:i,props:{},children:[{type:a,value:"-s foo"}]},{type:a,value:" and it can change\nthe Storage engine."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Turns out that "},{type:b,tag:i,props:{},children:[{type:a,value:bi}]},{type:a,value:" is a Kernel module, and that latest Ubuntu 14.04 has it\n"},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdocker\u002Fpull\u002F10860",rel:[p,q,r],target:s},children:[{type:a,value:"but not in the default kernel package"}]},{type:a,value:". You have to make sure that\n"},{type:b,tag:i,props:{},children:[{type:a,value:"linux-image-extra-virtual"}]},{type:a,value:cb},{type:b,tag:i,props:{},children:[{type:a,value:"aufs-tools"}]},{type:a,value:" are installed."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Documentation and notes recommends to download and "},{type:b,tag:n,props:{href:"https:\u002F\u002Fget.docker.com\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"run a shell script"}]},{type:a,value:" to\ninstall Docker instead of using the distribution packages. But I refuse to\nfollow this advice because I already manage via Salt stack every components of\nthe infrastructure. I just needed to put the right pieces together."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Since those changes are specific to Discourse I didn't wanted to make a pull\nrequest to "},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fdocker-formula",rel:[p,q,r],target:s},children:[{type:b,tag:M,props:{},children:[{type:a,value:"saltstack-formulas\u002Fdocker-formula"}]}]},{type:a,value:" right away, i'd need to\n"},{type:b,tag:n,props:{href:"https:\u002F\u002Fdocs.saltstack.com\u002Fen\u002Flatest\u002Ftopics\u002Fdevelopment\u002Fconventions\u002Fformulas.html",rel:[p,q,r],target:s},children:[{type:a,value:"follow Salt formula conventions"}]},{type:a,value:" and add more logic for my PR to be usable\nby other server runtime too. Not something I had in my plans today."}]},{type:a,value:e},{type:b,tag:X,props:{id:aK},children:[{type:b,tag:n,props:{href:cc,ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:ay}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"On the salt master, make sure you have the following:"}]},{type:a,value:e},{type:b,tag:N,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Add "},{type:b,tag:i,props:{},children:[{type:a,value:"saltstack-formulas\u002Fdocker-forumla"}]},{type:a,value:" in your gitfs entries"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# \u002Fetc\u002Fsalt\u002Fmaster.d\u002Fgitfs.conf"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"fileserver_backend"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" roots\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" git\n\n"},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"gitfs_remotes"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:cd},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\u002F\u002Fgithub.com\u002Fsaltstack"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"formulas\u002Fdocker"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"formula.git\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{start:Q},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Ensure you have "},{type:b,tag:i,props:{},children:[{type:a,value:ca}]},{type:a,value:" in your base top file"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# \u002Fsrv\u002Fsalt\u002Ftop.sls"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"base"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"'backend-discourse*'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" discourse\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{start:W},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Create add those lines in "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fsrv\u002Fsalt\u002Fdiscourse\u002Finit.sls"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fdocker-formula"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:"% set kernelrelease = salt"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:at}]},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"'grains.get'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:au}]},{type:a,value:"('kernelrelease') "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bj},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:bj},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" set dir = '\u002Fsrv\u002Fwebplatform\u002Fdiscourse' "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:bj},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:bk},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"include"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" docker\n\n"},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"\u002Fetc\u002Fdefault\u002Fdocker"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:ce}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"contents"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:G}]},{type:b,tag:c,props:{className:[d,"scalar",z]},children:[{type:a,value:"\n        # Docker Upstart and SysVinit configuration file\n        #\n        # Managed by Salt Stack, at {{ source }}. Do NOT edit manually!\n        # Docker dependencies: Refer to the script at https:\u002F\u002Fget.docker.com\u002F\n        # Available cli options: http:\u002F\u002Fdocs.docker.com\u002Freference\u002Fcommandline\u002Fcli\u002F\n        DOCKER_OPTS=\"--dns 8.8.8.8 -s aufs\""}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"watch_in"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:cf}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" docker"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"service\n    "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bl}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bm}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" lxc"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"docker\n      "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bm}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:cg},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"kernel"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"deps\n\n"},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"linux-kernel-deps"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:ch}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"pkgs"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:cg},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"image"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"extra"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:" kernelrelease "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" aufs"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"tools\n  "},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aO}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" modprobe aufs\n    "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aP}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" modinfo aufs "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:y}]},{type:a,value:" \u002Fdev\u002Fnull 2"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:y}]},{type:b,tag:c,props:{className:[d,an]},children:[{type:a,value:"&1"}]},{type:a,value:bk},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"clone-discourse"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:ch}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ci},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"git.latest"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:cd},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\u002F\u002Fgithub.com\u002Fdiscourse\u002Fdiscourse_docker.git\n    "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aQ}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:bn},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"target"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:aR},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aP}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" test "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"f "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:aR},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:"\u002Fcontainers\u002Fapp.yml\n    "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bl}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"file"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:aR},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bm}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ci},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"file.directory"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:aR},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aQ}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:bn},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:cj}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:bn},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"recurse"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" user\n      "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" group\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{start:ck},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Restart your salt master service, sync everything and run highstate"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:cf}]},{type:a,value:" salt-master restart\nsalt "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"* saltutil.sync_all\nsalt "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"* service.restart salt-minion\nsalt discourse-backend"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:cl}]}]}]},{type:a,value:e},{type:b,tag:N,props:{start:5},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Go to the VM and run the installer"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Note that as long as there is no "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fsrv\u002Fwebplatform\u002Fdiscourse\u002Fcontainers\u002Fapp.yml"}]},{type:a,value:"\nthe states will update the git "},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fdiscourse\u002Fdiscourse_docker",rel:[p,q,r],target:s},children:[{type:a,value:"repository to the latest version"}]},{type:a,value:". In my\nprojects, I make sure that salt also generates a configuration file with my\ncurrent environment details (e.g. DNS, Salt master, Redis, SMTP relay, Postgres'\nprivate IP addresses)."}]}]},dir:"\u002Fblog\u002F2015\u002F04",path:"\u002Fblog\u002F2015\u002F04\u002Finstall-discourse-docker-ubuntu-14-04-aufs-enabled",extension:al,slug:"install-discourse-docker-ubuntu-14-04-aufs-enabled",createdAt:cm,updatedAt:cm,category:am,prettyfiedTemporalDate:{prettified:"Thursday, April 2, 2015",temporalDate:"2015-04-02"}},{title:"A few useful GNU\u002FLinux truth tests while creating salt states",locale:ar,created:"2015-03-10T00:00:00.000Z",updated:bh,canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F03\u002Fuseful-gnulinux-truth-tests\u002F",status:aj,revising:O,caption:B,caracteresBizzares:B,gallery:B,migrateCode:O,migrateImages:B,migrateLinks:B,categories:[aN],tags:[aH,ab,as,"procedures"],keywords:[cn,"usermod"],description:co,excerpt:co,toc:[{id:cp,depth:Q,text:cq},{id:cr,depth:Q,text:"Change ownership on a folder only if its not what we expect"}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"Nothing amazing here, just that in some situations I want to run commands in\nsalt stack only in some situations that should be enforced."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Those tests are written within Salt stack states and YAML, but the test are\nplain GNU\u002FLinux "},{type:b,tag:i,props:{},children:[{type:a,value:"tests"}]},{type:a,value:ak}]},{type:a,value:e},{type:b,tag:X,props:{id:cp},children:[{type:b,tag:n,props:{ariaHidden:A,href:"#add-group-additional-membership-to-user",tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:cq}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[Y,x]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:cs}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aO}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aP}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"'grep \"^amavis\" \u002Fetc\u002Fgroup | grep -q -e clamav'"}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"A similar alternate could also be"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[Y,x]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:cs}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aO}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aP}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:aS},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aT},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"e '^amavis."},{type:b,tag:c,props:{className:[d,an]},children:[{type:a,value:"*clamav$'"}]},{type:a,value:" \u002Fetc\u002Fgroup\n"}]}]}]},{type:a,value:e},{type:b,tag:X,props:{id:cr},children:[{type:b,tag:n,props:{ariaHidden:A,href:"#change-ownership-on-a-folder-only-if-its-not-what-we-expect",tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:"Change ownership on a folder "},{type:b,tag:M,props:{},children:[{type:a,value:"only if"}]},{type:a,value:" its not what we expect"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[Y,x]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:"% for es_folder in "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:at}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"'\u002Fusr\u002Fshare\u002Felasticsearch\u002Fdata'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ao}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"'\u002Fvar\u002Flib\u002Felasticsearch'"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:au}]},{type:a,value:" %"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:"\nchown "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"R app"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aQ},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"app"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"user "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:" es_folder "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aO}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"onlyif"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"\"test `stat -c %G {{ es_folder }}` != app-user\""}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:"% endfor %"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:e}]}]}]}]},dir:ct,path:"\u002Fblog\u002F2015\u002F03\u002Fuseful-gnulinux-truth-tests",extension:al,slug:"useful-gnulinux-truth-tests",createdAt:aU,updatedAt:aU,category:aN,prettyfiedTemporalDate:{prettified:"Tuesday, March 10, 2015",temporalDate:"2015-03-10"}},{title:"Creating a new Ubuntu Salt master from the terminal using Cloud-Init",locale:ar,created:"2015-03-09T00:00:00.000Z",updated:bh,canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F03\u002Fcreating-new-ubuntu-salt-master-terminal-using-cloud-init\u002F",status:aj,revising:O,caption:B,caracteresBizzares:B,gallery:B,migrateCode:O,migrateImages:B,migrateLinks:B,categories:[am],tags:[bd,aH,ab,as],keywords:[cn,"OpenStack","Cloud Init"],excerpt:"Cloud-Init is made in a way that it handles distribution specific package installation details automatically. With it, you can create a new salt master in a few commands.",coverImage:{src:"~\u002Fassets\u002Fcontent\u002Fblog\u002F2015\u002F03\u002Fopenstack-cloudinit-screenshot.jpg",text:"[Open Stack Cloud-Init](https:\u002F\u002Fcloudinit.readthedocs.io\u002Fen\u002Flatest\u002F) documentation.\n"},description:"Creating new Salt master in a few commands with Cloud-Init",toc:[{id:cu,depth:Q,text:cv}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"If you run on Virtual Machines on a provider that runs OpenStack you can also\nleverage a component that’s made to automatically install softwares at creation\ntime. With this, you can any new node in your cluster, including the salt-master\nin a few terminal commands."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Before starting out, you need to make sure your cloud provider runs Open Stack\nand has "},{type:b,tag:n,props:{href:aV,rel:[p,q,r],target:s,title:aW},children:[{type:a,value:az}]},{type:a,value:" enabled. To check it out, look in the \"Launch instance\"\ndialog to create a new VM a tab titled \"Post-Creation\", it might just simply\nwork."}]},{type:a,value:e},{type:b,tag:cw,props:{style:cx,src:"~\u002Fassets\u002Fcontent\u002Fblog\u002F2015\u002F03\u002Fopenstack-cloudinit-launchinstance-dialog.png",alt:"OpenStack Cloud-Init dialog"},children:[{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:n,props:{href:aV,rel:[p,q,r],target:s,title:aW},children:[{type:a,value:az}]},{type:a,value:" is basically reading a manifest that declares what’s the\nspecifics of the new VM and is part of the conversion from the initial image\nOpenStack into the specific instance you will be using. You can follow those\n"},{type:b,tag:n,props:{href:aX,rel:[p,q,r],target:s,title:cy},children:[{type:a,value:"two"}]},{type:a,value:o},{type:b,tag:n,props:{href:aX,rel:[p,q,r],target:s,title:bo},children:[{type:a,value:"articles"}]},{type:a,value:" that describes well how "},{type:b,tag:R,props:{},children:[{type:a,value:az}]},{type:a,value:" works."}]},{type:a,value:e},{type:b,tag:bp,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:n,props:{href:aV,rel:[p,q,r],target:s,title:aW},children:[{type:a,value:az}]},{type:a,value:" is made in a way that it handles distribution specific\npackage installation details automatically."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The following is specific to an "},{type:b,tag:R,props:{},children:[{type:a,value:"Ubuntu server"}]},{type:a,value:" VM, but you might need to adjust\nthe package names to match your current server distribution as those tools are\ngetting more and more popular in the industry."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Before testing out on a new VM, you could also check from an existing instance\nand ask through an HTTP request what was the current instance’ post-creation\nscript using cURL."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Note that the IP address you see below is a virtual interface provided by\nOpenStack but can be navigated through HTTP, try it out like this;"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[K,x]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:bg}]},{type:a,value:" http:\u002F\u002F169.254.169.254\u002Fopenstack\u002F\n\n  "},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:"2012"}]},{type:a,value:"-08-10\n  "},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:cz}]},{type:a,value:"-04-04\n  "},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:cz}]},{type:a,value:"-10-17\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"If you see a similar output, you can ask what was the post-creation\nconfiguration (\"userdata\") it used at creation time. You can dig the tree,\nhere’s how you can find it in an OpenStack (CURRENT VERSION NICKNAME) cluster."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"For instance, my a salt master would have the following configuration;"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[K,x]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:bg}]},{type:a,value:" http:\u002F\u002F169.254.169.254\u002Fopenstack\u002F2013-10-17\u002Fuser_data\n\n  "},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:cA}]},{type:a,value:"\n  manage_etc_hosts: "},{type:b,tag:c,props:{className:[d,af]},children:[{type:a,value:aY}]},{type:a,value:"\n  manage-resolv-conf: "},{type:b,tag:c,props:{className:[d,af]},children:[{type:a,value:aY}]},{type:a,value:"\n  locale: en_US.UTF-8\n  timezone: America\u002FNew_York\n  package_upgrade: "},{type:b,tag:c,props:{className:[d,af]},children:[{type:a,value:A}]},{type:a,value:"\n  package_update: "},{type:b,tag:c,props:{className:[d,af]},children:[{type:a,value:A}]},{type:a,value:"\n  package_reboot_if_required: "},{type:b,tag:c,props:{className:[d,af]},children:[{type:a,value:A}]},{type:a,value:"\n\n  ssh_import_id: "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:at}]},{type:a,value:"saltstack"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:au}]},{type:a,value:"\n  apt_sources:\n    - source: "},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"\"ppa:saltstack\u002Fsalt\""}]},{type:a,value:"\n\n  packages:\n    - salt-minion\n    - salt-common\n    - salt-master\n    - python-software-properties\n    - software-properties-common\n    - python-novaclient\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"To boot an instance from the terminal, you can use the \"nova\" command like this;"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[K,x]},children:[{type:b,tag:i,props:{},children:[{type:a,value:cB},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:aA},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bq}]},{type:a,value:br},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"\n     --user-data \u002Fsrv\u002Fcloudconfig.yml "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:aA},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bs}]},{type:a,value:" keyname "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:aA},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bt}]},{type:a,value:" subsonic "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:cC},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"\n     salt\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"This assumes that you have the following available in your OpenStack dashboard:"}]},{type:a,value:e},{type:b,tag:N,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"An SSH public key called \"keyname\" in your tenant"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"A flavor called \"subsonic\" that has a predefined configuration of vCPU, vRAM,\netc."}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"A security group called \"default\", you could use more than one by separating\nthem by comas; e.g. default,foo,bar"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"A text file in "},{type:b,tag:i,props:{},children:[{type:a,value:cD}]},{type:a,value:" in YAML format that holds your\n"},{type:b,tag:n,props:{href:aV,rel:[p,q,r],target:s,title:aW},children:[{type:a,value:az}]},{type:a,value:" (a.k.a. \"userdata\") configuration."}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"You have your nova configuration available (look in your cloud provider\ndashboard \"Download OpenStack RC File\" link in \"Access & Security\" and \"API\naccess\") and available in your server’s "},{type:b,tag:i,props:{},children:[{type:a,value:cE}]},{type:a,value:" profile folder."}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"You have \""},{type:b,tag:i,props:{},children:[{type:a,value:bu}]},{type:a,value:"\" (or its equivalent) installed"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"To test it out yourself, you could use the block I gave earlier and create a\nfile in "},{type:b,tag:i,props:{},children:[{type:a,value:cD}]},{type:a,value:" and give the the "},{type:b,tag:R,props:{},children:[{type:a,value:aZ}]},{type:a,value:" command a try."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"In this case, you might want to call the new VM \"salt\" as the default Salt stack\nconfiguration will try to communicate to it to make it its salt master. In this\ncase, it’ll be itself."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The creation of the salt master could also contain a few git repositories to be\ncloned at the salt master creation time making your salt master as easily\nreplaceable as any other components in your \"cloud\"."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"A set of sample scripts I use to create a new salt master off of a few\n"},{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002F01c09df78f05612c281f",rel:[p,q,r],target:s},children:[{type:a,value:"git repositories can be found in the following Gist"}]}]},{type:a,value:e},{type:b,tag:X,props:{id:cu},children:[{type:b,tag:n,props:{href:"#read-more",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:cv}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The following articles was found to be describing in more detail what I\nintroduced in this article."}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:aX,rel:[p,q,r],target:s,title:cy},children:[{type:a,value:"Easily automate The provisioning of your DigitalOcean Droplets"}]},{type:a,value:". Don’t be\nfooled by the name, the article is actually describing "},{type:b,tag:R,props:{},children:[{type:a,value:az}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:aX,rel:[p,q,r],target:s,title:bo},children:[{type:a,value:bo}]}]},{type:a,value:e}]}]},dir:ct,path:"\u002Fblog\u002F2015\u002F03\u002Fcreating-new-ubuntu-salt-master-terminal-using-cloud-init",extension:al,slug:"creating-new-ubuntu-salt-master-terminal-using-cloud-init",createdAt:aU,updatedAt:aU,category:am,prettyfiedTemporalDate:{prettified:"Monday, March 9, 2015",temporalDate:"2015-03-09"}},{title:"Quelques bouts de code pour automatiser le déploiement",locale:cF,created:cG,updated:"2015-02-17T00:00:00.000Z",canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F01\u002Fquelques-bouts-de-code-pour-automatiser-le-deploiement\u002F",status:aj,revising:B,migrateLinks:O,migrateImages:B,gallery:B,caption:B,categories:[am],tags:[as,cH,bd,ab],coverImage:{src:"~\u002Fassets\u002Fcontent\u002Fblog\u002F2015\u002F01\u002Fautomate-all-the-things-300x284.png",srcset:["https:\u002F\u002Frenoirb.github.io\u002Fsite-assets\u002Fassets\u002Fcontent\u002Fblog\u002F2015\u002F01\u002Fautomate-all-the-things-300x284.png 300w","https:\u002F\u002Frenoirb.github.io\u002Fsite-assets\u002Fassets\u002Fcontent\u002Fblog\u002F2015\u002F01\u002Fautomate-all-the-things-1024x971.png 1024w","https:\u002F\u002Frenoirb.github.io\u002Fsite-assets\u002Fassets\u002Fcontent\u002Fblog\u002F2015\u002F01\u002Fautomate-all-the-things.png 1600w"],sizes:cI,alt:"Illustration souvent utilisée pour un mème de l’Internet d’un dessin fait rapidement à la main illustrant un personnage avec une lumière éclatante derrière comme l’introduction d’un super héros. Le personnage tient un balai d’une main et brandissant l’autre bras et les yeux pas très alignés. Il proclame Automatisons tout!",text:"Automatisons Tout!!1\n"},preamble:{disable:O,text:o},excerpt:"Avez-vous déjà voulu automatiser le déploiement de votre infrastructure serveurs web de A-Z? C’est exactement sur quoi je travaille en ce moment.",toc:[{id:cJ,depth:Q,text:cK},{id:cL,depth:Q,text:cM},{id:cN,depth:Q,text:cO}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"Ce billet n’est qu’un simple «link dump» pour retrouver parmi plusieurs notes\néparpillés. Je compte éventuellement publier la totalité de mon travail dans des\nprojets publics sur GitHub une fois la boucle complétée. Le tout sans fournir\nles données privés, évidemment."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Faire le saut vers l’automatisation demande beaucoup de préparation et je prends\nle temps de publier ici quelques bouts de code que j’ai écrits pour compléter la\ntâche."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Au final, mon projet permettra de déployer un site qui s’appuie sur un cluster\nMariaDB, Memcached, une stack LAMP («prefork») lorsqu’on a pas le choix, une\nstack [HHVM\u002Fphp5-fpm, Python, nodejs] app servers pour le reste servi par un\nfrontend NGINX. Mes scripts vont déployer une série d’applications web avec\ntoutes les dépendances qui les adaptent géré dans leur propre «git repo» parent.\nDans mon cas, ce sera: WordPress, MediaWiki, Discourse, et quelques autres."}]},{type:a,value:e},{type:b,tag:X,props:{id:cJ},children:[{type:b,tag:n,props:{href:"#requis",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:cK}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Instantiation à partir de commandes "},{type:b,tag:i,props:{},children:[{type:a,value:aZ}]},{type:a,value:" du terminal, crée une nouvelle VM\nmise à jour et son nom définit son rôle dans le réseau interne"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Les VMs sont uniquement accessible par un Jump box (i.e. réseau interne\nseulement)"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Un système regarde si un répertoire clone git à eu des changements sur la\nbranche «master», lance un événement si c’est le cas"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Chaque machine sont construites à partir d’une VM minimale. Dans ce cas-ci;\nUbuntu 14.04 LTS"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Système doit s’assurer que TOUTES les mises à jour sont appliqués\nrégulièrement"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Système doit s’assurer que ses services interne sont fonctionnels"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Dans le cas d’une situation où une VM atteint le seuil critique OOM, la VM\nredémarre automatiquement"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Le nom de la VM décrit son rôle, et les scripts d’installation installent les\nrequis qui y sont affectés"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Les configurations utilisent les détails (e.g. adresses IP privés et\npubliques) de chaque pool (e.g. redis, memcache, mariadb) et ajuste\nautomatiquement les configurations dans chaque application"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"... etc."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:X,props:{id:cL},children:[{type:b,tag:n,props:{href:"#bouts-de-code",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:cM}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:cP,rel:[p,q,r],target:s},children:[{type:a,value:"Installation automatisée d’un cluster MariaDB avec réplication SSL"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002F6ecf0d852a9148741bef",rel:[p,q,r],target:s},children:[{type:a,value:"Configuration SSH pour accéder aux VMs du réseau interne"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002F437f763b948c926ca7ba",rel:[p,q,r],target:s},children:[{type:a,value:"Vérifier si un git repo a changé"}]},{type:a,value:", j’ai prévu faire un \"salt-call\" qui\ntrigger un événement Salt Reactor pour lancer un build run"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:cQ,rel:[p,q,r],target:s},children:[{type:a,value:"Configuration Monit"}]},{type:a,value:" pour s’assurer que les services «sont up and running»"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:bv,rel:[p,q,r],target:s},children:[{type:a,value:"Installer automatiquement une VM enregistrée au salt-master"}]},{type:a,value:" via Salt\nReactor. Le nom de la VM déclare son rôle, le reste se fait tout seul\n(incomplet mais un début)"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002Frenoirb\u002F1b42edac44c723185c9d",rel:[p,q,r],target:s},children:[{type:a,value:"Installer des plugins WordPress à partir des repos Git\u002FSVN\u002FFichiers Zip"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:cR,rel:[p,q,r],target:s},children:[{type:a,value:"Installation automatique d’un salt-master"}]},{type:a,value:" et des dépendances de build"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:cS,rel:[p,q,r],target:s},children:[{type:a,value:"Définir le rôle d’une VM basé sur son nom + TLD"}]},{type:a,value:" (e.g.\nredis-sessions.production.wpdn)"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002Frenoirb\u002F11258261",rel:[p,q,r],target:s},children:[{type:a,value:"Vérifier avec l’origine d’un clone git s’il y a des changements upstream,\nlancer un événement si c’est le cas"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:bv,rel:[p,q,r],target:s},children:[{type:a,value:"Automatiser des commands selon certains événemnts dans un cluster géré par\nSalt"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:cR,rel:[p,q,r],target:s},children:[{type:a,value:"Automatiser l’installation d’un salt master basé uniquement sur une série de\ngit repos et d’un bootstrapper script"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002Fe925fee9b6085d7cbec4",rel:[p,q,r],target:s},children:[{type:a,value:"Automatiser les backups ElasticSearch"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:cQ,rel:[p,q,r],target:s},children:[{type:a,value:"Système pour s’assurer que tous les services son fonctionnels, comment tester\ns’ils fonctionnent et comment les redémarrer"}]},{type:a,value:" avec "},{type:b,tag:M,props:{},children:[{type:a,value:"Monit"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:X,props:{id:cN},children:[{type:b,tag:n,props:{href:"#billets-inspirants-sur-le-sujet",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:cO}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"http:\u002F\u002Fblog.hendrikvolkmer.de\u002F2013\u002F04\u002F03\u002Fthere-will-be-no-reliable-cloud-part-1\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"There will be no reliable cloud (part 1)"}]},{type:a,value:aL},{type:b,tag:n,props:{href:"http:\u002F\u002Fblog.hendrikvolkmer.de\u002F2013\u002F04\u002F09\u002Fthere-will-be-no-reliable-cloud-part-2\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"part 2"}]},{type:a,value:aL},{type:b,tag:n,props:{href:"http:\u002F\u002Fblog.hendrikvolkmer.de\u002F2013\u002F04\u002F12\u002Fthere-will-be-no-reliable-cloud-part-3\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"part 3"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"http:\u002F\u002Fblog.hendrikvolkmer.de\u002F2013\u002F10\u002F11\u002Fthe-missing-piece-operating-systems-for-web-scale-cloud-apps\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"The missing piece operating systems for \"Web Scale\" Cloud Apps"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"http:\u002F\u002Fwww.rightbrainnetworks.com\u002Fblog\u002Fwhy-an-ec2-instance-isnt-a-server\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"Why an X (VM) \"instance\" isn’t a server"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"http:\u002F\u002Fsamj.net\u002F2012\u002F03\u002F08\u002Fsimplifying-cloud-reliability\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"Simplifying cloud reliability"}]}]},{type:a,value:e}]},{type:a,value:e}]},dir:cT,path:"\u002Fblog\u002F2015\u002F01\u002Fquelques-bouts-de-code-pour-automatiser-le-deploiement",extension:al,slug:"quelques-bouts-de-code-pour-automatiser-le-deploiement",createdAt:a_,updatedAt:a_,category:am,prettyfiedTemporalDate:{prettified:"mercredi 28 janvier 2015",temporalDate:"2015-01-28"}},{title:cU,locale:ar,created:cG,updated:"2015-02-03T00:00:00.000Z",canonical:cP,status:aj,revising:B,migrateLinks:O,migrateImages:B,gallery:B,caption:B,categories:[am],tags:[aH,cV,ab,as],keywords:["replication","database-server","cluster","configuration","mysql","MariaDB"],description:cU,excerpt:"Some notes on how I created our updated MariaDB database cluster with replication.",preamble:{text:"The following might still work if all software versions are still available in the exact versions ranges they were when initially published.\nPart of this article was written while maintaining WebPlatform’s Infrastructure maintenance. Mostly [in *WPD\u002FInfrastructure\u002Fprocedures\u002F* **Replacing a VM**](https:\u002F\u002Fwebplatform.github.io\u002Fdocs\u002FWPD\u002FInfrastructure\u002Fprocedures\u002FReplacing_a_VM\u002F), and [*WPD\u002FInfrastructure\u002Fprocedures\u002F* **Managing  MariaDB replication**](https:\u002F\u002Fwebplatform.github.io\u002Fdocs\u002FWPD\u002FInfrastructure\u002Fprocedures\u002FManaging_MySQL_replication\u002F)\n"},toc:[{id:cW,depth:Q,text:cX},{id:aK,depth:Q,text:ay},{id:cY,depth:W,text:cZ},{id:c_,depth:W,text:c$},{id:da,depth:W,text:db},{id:dc,depth:W,text:dd},{id:de,depth:W,text:df},{id:dg,depth:W,text:a$}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"While reworking WebPlatform infrastructure I had to rebuild a new database\ncluster."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The objective of the cluster is to have more than one database server so that\nour web applications can make reads on any node in the cluster."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"While the system has replication, and I can send reads on any nodes on the\ncluster. There is a flaw in it too, any nodes can "},{type:b,tag:R,props:{},children:[{type:a,value:"also"}]},{type:a,value:" make writes; nothing is\nblocking it."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"My plan is to change this so that it would be OK to send writes to anybody in\nthe cluster. There is now something called \"Galera\" that would allow me that.\nBut that's outside of the scope of this article."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"In the current configuration, I'm purposefully not fixing it because my\nconfiguration management makes sure only the current master. So in this setup, I\ndecided that the VM that gets writes has a specific mention of \"masterdb\" in the\nhostname."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"That way, its easy to see and it gives me the ability to change master at\nanytime if an emergency requires me to."}]},{type:a,value:e},{type:b,tag:X,props:{id:cW},children:[{type:b,tag:n,props:{href:"#changing-mariadb-replication-master",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:cX}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Changing master could be done in the following order:"}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Lock writes on masterdb databases"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Wait replication to catch up"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"On secondary database servers; remove replication configuration"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Tell all web apps to use new database master"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Remove database lock"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Setup new replication configuration to use new master"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Thanks to the fact that I manage "},{type:b,tag:M,props:{},children:[{type:a,value:"everything"}]},{type:a,value:" through configruation management\n--including the web app configuration files-- its only a matter of applying the\nstates everywhere in the cluster. That makes it fairly easy to do such an heavy\nmove, even under stress."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"This post will be updated once I have completed the multi writes setup."}]},{type:a,value:e},{type:b,tag:X,props:{id:aK},children:[{type:b,tag:n,props:{href:cc,ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:ay}]},{type:a,value:e},{type:b,tag:aa,props:{id:cY},children:[{type:b,tag:n,props:{href:"#assumptions",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:cZ}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The rest of this article will assume the following:"}]},{type:a,value:e},{type:b,tag:N,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"You are running VMs on OpenStack, and do have credentials to make API calls\nto it"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"You have a Salt master already running"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Your salt master has at least "},{type:b,tag:i,props:{},children:[{type:a,value:bu}]},{type:a,value:bY},{type:b,tag:i,props:{},children:[{type:a,value:aZ}]},{type:a,value:" commands) available\non it"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"You have your Open Stack credentials already loaded in your salt master's\n"},{type:b,tag:i,props:{},children:[{type:a,value:cE}]},{type:a,value:" so you can use "},{type:b,tag:i,props:{},children:[{type:a,value:aZ}]},{type:a,value:" directly"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:aa,props:{id:c_},children:[{type:b,tag:n,props:{href:"#from-the-salt-master-initiate-a-few-vms-to-use-for-your-database-cluster",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:c$}]},{type:a,value:e},{type:b,tag:N,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Before booting, ensure you have the following details in your OpenStack\ncluster and salt master;"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"You have a SSH key in your OpenStack cluster. Mine is called\n\"renoirb-production\" and my salt master user has the private key preinstalled"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"You have a "},{type:b,tag:i,props:{},children:[{type:a,value:dh}]},{type:a,value:" file that has settings that points to your salt\nmaster"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:"cat"}]},{type:a,value:" \u002Fsrv\u002Fopsconfigs\u002Fuserdata.txt\n"}]}]}]},{type:a,value:e},{type:a,value:e},{type:b,tag:di,props:{title:dj},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"I've noticed that this "},{type:b,tag:i,props:{},children:[{type:a,value:dh}]},{type:a,value:" file I've initially written for this\narticle has then been part of "},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fops\u002Fblob\u002Ff6e0390a\u002Fsalt-master",rel:[p,q,r],target:s,title:"salt-master\u002F* on GitHub.com\u002Fwebplatform\u002Fops as of 2015-06-08"},children:[{type:a,value:"WebPlatform’s \"ops\" repository"}]},{type:a,value:"\nfrom which I was (2015) using to work locally. In this repo, there was the\n"},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fops\u002Fblob\u002Ff6e0390a\u002Fsalt-master\u002Fsalt-userdata.yml",rel:[p,q,r],target:s,title:"salt-master\u002Fsalt-userdata.yml on GitHub.com\u002Fwebplatform\u002Fops as of 2015-06-08"},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt-master\u002Fsalt-userdata.yml"}]}]},{type:a,value:ak}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:cA}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"manage_etc_hosts"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,af,an]},children:[{type:a,value:aY}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# Has to be set to false for everybody. Otherwise we need a DNS"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"manage-resolv-conf"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,af,an]},children:[{type:a,value:aY}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"locale"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" en_US.UTF"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:"8"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"timezone"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" America\u002FNew_York\n"},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"package_upgrade"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,af,an]},children:[{type:a,value:A}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"package_update"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,af,an]},children:[{type:a,value:A}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"package_reboot_if_required"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,af,an]},children:[{type:a,value:A}]},{type:a,value:bk},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"#"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# This is run at EVERY boot, good to ensure things are at the right place"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# IMPORTANT, make sure that `10.10.10.22` is a valid local DNS server."}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"bootcmd"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aS},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aT},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"e 'nameserver' \u002Fetc\u002Fresolvconf\u002Fresolv.conf.d\u002Fhead "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:G}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:G}]},{type:a,value:" printf\n    \"nameserver 10.10.10.22\\n\" "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:y}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:y}]},{type:a,value:" \u002Fetc\u002Fresolvconf\u002Fresolv.conf.d\u002Fhead\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aS},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aT},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"e 'wpdn' \u002Fetc\u002Fresolvconf\u002Fresolv.conf.d\u002Fbase "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:G}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:G}]},{type:a,value:" printf \"search\n    production.wpdn\\ndomain production.wpdn\\nnameserver 8.8.8.8\" "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:y}]},{type:a,value:"\n    \u002Fetc\u002Fresolvconf\u002Fresolv.conf.d\u002Fbase\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aS},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aT},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"e 'wpdn' \u002Fetc\u002Fresolv.conf "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:G}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:G}]},{type:a,value:" resolvconf "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"u\n\n"},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"runcmd"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" sed "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"i \"s\u002F127.0.0.1 localhost\u002F127.0.1.1 $(hostname).production.wpdn\n    $(hostname)\\n127.0.0.1 localhost\u002F\" \u002Fetc\u002Fhosts\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ba},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"get install software"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"properties"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"common python"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"software"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"properties\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" add"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"apt"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"repository "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"y ppa"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"saltstack\u002Fsalt\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ba},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"get update\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ba},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:dk},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"y upgrade\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:ba},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:dk},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"y autoremove\n\n"},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"packages"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aM},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"minion\n  "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:aM},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"common\n"},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# vim: et ts=2 sw=2 ft=yaml syntax=yaml"}]},{type:a,value:e}]}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:N,props:{start:Q},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Create two "},{type:b,tag:i,props:{},children:[{type:a,value:"db"}]},{type:a,value:"-type VMs"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:cB},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:aA},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bq}]},{type:a,value:br},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"\n     --user-data \u002Fsrv\u002Fopsconfigs\u002Fuserdata.txt "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:aA},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bs}]},{type:a,value:dl},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:aA},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bt}]},{type:a,value:" lightspeed "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:cC},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"\n     db1-masterdb\n\n nova boot "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bq}]},{type:a,value:br},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"\n      --user-data \u002Fsrv\u002Fopsconfigs\u002Fuserdata.txt "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bs}]},{type:a,value:dl},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bt}]},{type:a,value:" supersonic "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"\n      --security-groups default "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"\n      db2\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Accept them to the salt"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt-key "},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:dm}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:dn}]},{type:a,value:" db1-masterdb\nsalt-key "},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:dm}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:dn}]},{type:a,value:" db2\n"}]}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"As an aside. Imagine you want to run dependencies automatically once a VM is\npart of your salt-master. For example, adding its private IP address in a local\n"},{type:b,tag:R,props:{},children:[{type:a,value:"Redis"}]},{type:a,value:" or "},{type:b,tag:R,props:{},children:[{type:a,value:"Etcd"}]},{type:a,value:" live configuration object. One could create a "},{type:b,tag:n,props:{href:"https:\u002F\u002Fdocs.saltproject.io\u002Fen\u002Flatest\u002Ftopics\u002Freactor\u002F",rel:[p,q,r],target:s},children:[{type:a,value:"Salt\n\""},{type:b,tag:R,props:{},children:[{type:a,value:"Reactor"}]},{type:a,value:"\""}]},{type:a,value:" and make "},{type:b,tag:n,props:{href:bv,rel:[p,q,r],target:s},children:[{type:a,value:"sure the data is refreshed. This gist is a good\nstarting point"}]},{type:a,value:" 4. Wait the VM build to finish and get their private IP\naddresses"}]},{type:a,value:e},{type:b,tag:N,props:{start:ck},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Wait the VM build to finish and get their private IP addresses"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"nova list "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:"grep"}]},{type:a,value:" db\n\n  "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:do0}]},{type:a,value:dp},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:" db1-masterdb "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:dq},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:dr},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:ds},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:bw}]},{type:a,value:".10.73 "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:do0}]},{type:a,value:dp},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:" db2          "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:dq},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:dr},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:ds},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:bw}]},{type:a,value:".10.74 "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:G}]},{type:a,value:e}]}]}]},{type:a,value:e},{type:b,tag:cw,props:{style:cx,src:bC,alt:"OpenStack nova command",figcaption:o},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Command output when issuing "},{type:b,tag:i,props:{},children:[{type:a,value:"nova list"}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Add them to the pillars. Note that the part of the name \"masterdb\" is what\nSalt states uses to know which one will get the writes to. Note that in the\nend, the web apps configs will use the private IP address. Its quicker to\ngenerate pages if the backend doesn't need to make name resolution each time\nit makes database queries. This is why we have to reflect the pillars. Ensure\nthe following structure exists in the file."}]},{type:a,value:e},{type:b,tag:di,props:{title:dj},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The following file is now "},{type:b,tag:M,props:{},children:[{type:a,value:"GitHub.com\u002FWebPlatform\u002Fsalt-pillar"}]},{type:a,value:" project,\n"},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fsalt-pillar\u002Ftree\u002F3d718578\u002Finfra",rel:[p,q,r],target:s,title:"infra\u002F* on GitHub.com\u002Fwebplatform\u002Fsalt-pillar as of 2015-06-08"},children:[{type:a,value:"and looked like this"}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"# Edit \u002Fsrv\u002Fpillar\u002Finfra\u002Finit.sls at the following blocks"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"infra"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:dt}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bx}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" 10.10.10.73\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Refer to the right IP address in the configuration file with a similar salt\n"},{type:b,tag:i,props:{},children:[{type:a,value:"pillar.get"}]},{type:a,value:" reference ("},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fsalt-states\u002Fblob\u002F20150608\u002Fcode\u002Ffiles\u002Fblog\u002Flocal.php.jinja",rel:[p,q,r],target:s,title:"code\u002Ffiles\u002Fblog\u002Flocal.php.jinja on GitHub.com\u002Fwebplatform\u002Fsalt-states as of 2015-06-08"},children:[{type:a,value:"config template"}]},{type:a,value:aL},{type:b,tag:n,props:{href:"https:\u002F\u002Fgithub.com\u002Fwebplatform\u002Fsalt-states\u002Fblob\u002F20150608\u002Fcode\u002Fblog.sls#L48-L55",rel:[p,q,r],target:s,title:"code\u002Fblog.sls on GitHub.com\u002Fwebplatform\u002Fsalt-states as of 2015-06-08"},children:[{type:a,value:"state to write\nconfig template to filesystem"}]},{type:a,value:")."}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"\u002Fsrv\u002Fwebplatform\u002Fblog\u002Fwp-config.php"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:ce}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"source"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:aM},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"\u002F\u002Fcode\u002Ffiles\u002Fblog\u002Fwp"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"config.php.jinja\n    "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"template"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" jinja\n    "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:aQ}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:du},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:dv},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:cj}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:du},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:dv},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"context"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"db_creds"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:aM},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:at}]},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:dw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:au}]},{type:a,value:"('accounts"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"wiki"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"db') "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:ad},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"masterdb_ip"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:E}]},{type:a,value:aM},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:at}]},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:dw}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:au}]},{type:a,value:"('infra"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:dt},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:"masterdb') "},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:F}]},{type:a,value:C},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:bl}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:$},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"cmd"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:" rsync"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:"blog\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"... and the "},{type:b,tag:i,props:{},children:[{type:a,value:"wp-config.php.jinja"}]}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,dx]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,"php",dx]},children:[{type:b,tag:c,props:{className:[d,"delimiter",an]},children:[{type:a,value:"\u003C?php"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"## Managed by Salt Stack, please DO NOT TOUCH, or ALL CHANGES WILL be LOST!"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,_]},children:[{type:a,value:"## source {{ source }}"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:aB}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aC}]},{type:b,tag:c,props:{className:[d,z,aD]},children:[{type:a,value:"'DB_CHARSET'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ao}]},{type:a,value:dy},{type:b,tag:c,props:{className:[d,z,aE]},children:[{type:a,value:"\"utf8\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ap}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:aB}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aC}]},{type:b,tag:c,props:{className:[d,z,aD]},children:[{type:a,value:"'DB_COLLATE'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ao}]},{type:a,value:dy},{type:b,tag:c,props:{className:[d,z,aE]},children:[{type:a,value:"\"\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ap}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:aB}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aC}]},{type:b,tag:c,props:{className:[d,z,aD]},children:[{type:a,value:"'DB_HOST'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ao}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,z,aE]},children:[{type:a,value:"\"{{ masterdb_ip|default('127.0.0.1')    }}\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ap}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:aB}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aC}]},{type:b,tag:c,props:{className:[d,z,aD]},children:[{type:a,value:"'DB_NAME'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ao}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,z,aE]},children:[{type:a,value:"\"{{ db_creds.database|default('wpblog') }}\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ap}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:aB}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aC}]},{type:b,tag:c,props:{className:[d,z,aD]},children:[{type:a,value:"'DB_USER'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ao}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,z,aE]},children:[{type:a,value:"\"{{ db_creds.username|default('root')   }}\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ap}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:aB}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aC}]},{type:b,tag:c,props:{className:[d,z,aD]},children:[{type:a,value:"'DB_PASSWORD'"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ao}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,z,aE]},children:[{type:a,value:"\"{{ db_creds.password|default('')       }}\""}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ap}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:aF}]},{type:a,value:e}]}]}]}]},{type:a,value:e},{type:b,tag:N,props:{start:7},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Refresh the pillars, rebuild the salt master "},{type:b,tag:i,props:{},children:[{type:a,value:dz}]},{type:a,value:", and test it\nout."}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt-call saltutil.sync_all\nsalt salt state.highstate\n\nsalt-call pillar.get infra:hosts_entries:masterdb\n"},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:" local:\n"},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:"   "},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:bw}]},{type:a,value:".10.73\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Make sure the VMs has the same version of salt as you do"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:" salt-call test.version\n "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:" local:\n "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:by}]},{type:a,value:".0\n\n salt db"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:"* test.version\n "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:" db2:\n "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:by}]},{type:a,value:".0\n "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:" db1-masterdb:\n "},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:by}]},{type:a,value:".0\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Kick the VMs installation"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt db"},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:D}]},{type:a,value:cl}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Highstate takes a while to run, but once you are done, you should be able to\nwork with them with the remaining of this tutorial"}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:bz},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bA}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:dA}]},{type:a,value:" mysql.version\n"},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dB},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:dC}]},{type:a,value:dD},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dE},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:aq},{type:b,tag:c,props:{className:[d,P]},children:[{type:a,value:dC}]},{type:a,value:dD}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Each db-type VM MySQL\u002FMariaDB\u002FPercona server will have a "},{type:b,tag:R,props:{},children:[{type:a,value:"different"}]},{type:a,value:" database\nmaintenance users defined in "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fetc\u002Fmysql\u002Fdebian.cnf"}]},{type:a,value:ak}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Make sure you don't overwrite them unless you import everything all at once,\nincluding the users and their grants. 11. Check that each db VMs has their SSL\ncertificate generated by Salt"}]},{type:a,value:e},{type:b,tag:N,props:{start:11},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Check that each db VMs has their SSL certificate generated by Salt"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:bz},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bA}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:dA}]},{type:a,value:" cmd.run "},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"'ls \u002Fetc\u002Fmysql | grep pem'"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dB},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dF},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dG},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dH},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dI},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dJ},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dK},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dL},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dM},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dE},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dF},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dG},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dH},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dI},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dJ},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dK},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dL},{type:b,tag:c,props:{className:[d,u]},children:[{type:a,value:y}]},{type:a,value:dM}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Each file is a certificate so they can use to make replication through SSL."}]},{type:a,value:e},{type:b,tag:aa,props:{id:da},children:[{type:b,tag:n,props:{href:"#now-on-each-database-server",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:db}]},{type:a,value:e},{type:b,tag:N,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Connect to both db nodes using the salt as a Jump Host"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:dN}]},{type:a,value:" masterdb.production.wpdn\n"},{type:b,tag:c,props:{className:[d,Z]},children:[{type:a,value:dN}]},{type:a,value:" db2.production.wpdn\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Get to the MySQL\u002FMariaDB\u002FPercona prompt on each VMs."}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"If you are used with terminal screens that allows to keep sessions running even\nif you get disconnected, that would be ideal. We never know if the connection\nhangs."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"On WebPlatform system we do have "},{type:b,tag:i,props:{},children:[{type:a,value:"screen"}]},{type:a,value:" but "},{type:b,tag:i,props:{},children:[{type:a,value:"tmux"}]},{type:a,value:" can do too."}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,av]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"mysql\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{start:W},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Check if SSL is enabled on both MySQL\u002FMariaDB\u002FPercona servers"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,av]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"\u003E MariaDB [(none)]\u003E SHOW VARIABLES like '%ssl%';\n\u003E +---------------+----------------------------+\n\u003E | Variable_name | Value                      |\n\u003E +---------------+----------------------------+\n\u003E | have_openssl  | YES                        |\n\u003E | have_ssl      | YES                        |\n\u003E | ssl_ca        | \u002Fetc\u002Fmysql\u002Fca-cert.pem     |\n\u003E | ssl_capath    |                            |\n\u003E | ssl_cert      | \u002Fetc\u002Fmysql\u002Fserver-cert.pem |\n\u003E | ssl_cipher    | DHE-RSA-AES256-SHA         |\n\u003E | ssl_crl       |                            |\n\u003E | ssl_crlpath   |                            |\n\u003E | ssl_key       | \u002Fetc\u002Fmysql\u002Fserver-key.pem  |\n\u003E +---------------+----------------------------+\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Generate SSL certificates for MySQL\u002FMariaDB\u002FPercona server, see "},{type:b,tag:n,props:{href:"https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002Fdee3c76a88b3c44da564",rel:[p,q,r],target:s},children:[{type:a,value:"this\ngist"}]},{type:a,value:" on how to do it."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Places to double check; To see which config keys sets what's shown in the\nprevious screen, take a look in the VMs "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fetc\u002Fmysql\u002Fconf.d\u002F"}]},{type:a,value:" folders with\nsimilar entries."}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:bB}]},{type:a,value:" is what allows us to communicate between servers, before MySQL\n5.5 we had "},{type:b,tag:i,props:{},children:[{type:a,value:"skip-networking"}]},{type:a,value:" but now only a "},{type:b,tag:i,props:{},children:[{type:a,value:bB}]},{type:a,value:" is sufficient. Make\nsure that your security groups allows only local network connections though."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:dO}]},{type:a,value:" MUST be with a different number for each nodes. Make sure no\nserver has the same number."}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,"language-ini"]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,dP]},children:[{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:at}]},{type:b,tag:c,props:{className:[d,dQ,dR]},children:[{type:a,value:"mysqld"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:au}]}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:bB}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"0.0.0.0"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:"log-basename"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"mariadbrepl"}]},{type:a,value:"\nlog-bin\n"},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:"binlog-format"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"row"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:dO}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:bf}]},{type:a,value:dS},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:"ssl-cipher"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"DHE-RSA-AES256-SHA"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:"ssl-ca"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"\u002Fetc\u002Fmysql\u002Fca-cert.pem"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:dT}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"\u002Fetc\u002Fmysql\u002Fserver-cert.pem"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:dU}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"\u002Fetc\u002Fmysql\u002Fserver-key.pem"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,dP]},children:[{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:at}]},{type:b,tag:c,props:{className:[d,dQ,dR]},children:[{type:a,value:"client"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:au}]}]},{type:a,value:dS},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:dT}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"\u002Fetc\u002Fmysql\u002Fclient-cert.pem"}]},{type:a,value:e},{type:b,tag:c,props:{className:[d,j,ag]},children:[{type:a,value:dU}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,ah,ai]},children:[{type:a,value:"\u002Fetc\u002Fmysql\u002Fclient-key.pem"}]},{type:a,value:e}]}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:N,props:{start:6},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:M,props:{},children:[{type:a,value:"From the database master"}]},{type:a,value:" (a.k.a \"masterdb\"), Get the replication log\nposition; We'll need the "},{type:b,tag:i,props:{},children:[{type:a,value:"File"}]},{type:a,value:cb},{type:b,tag:i,props:{},children:[{type:a,value:"Position"}]},{type:a,value:" values to setup the\nreplication node."}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,av]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"MariaDB [(none)]\u003E show master status;\n\u003E +------------------------+----------+--------------+------------------+\n\u003E | File                   | Position | Binlog_Do_DB | Binlog_Ignore_DB |\n\u003E +------------------------+----------+--------------+------------------+\n\u003E | mariadbrepl-bin.000002 |      644 |              |                  |\n\u003E +------------------------+----------+--------------+------------------+\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Configure the "},{type:b,tag:i,props:{},children:[{type:a,value:bx}]},{type:a,value:" to accept replication users. "},{type:b,tag:M,props:{},children:[{type:a,value:"From the salt\nmaster"}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,K]},children:[{type:b,tag:i,props:{},children:[{type:a,value:bz},{type:b,tag:c,props:{className:[d,S,T]},children:[{type:a,value:bA}]},{type:a,value:o},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"'roles:masterdb'"}]},{type:a,value:" mysql.user_create replication_user "},{type:b,tag:c,props:{className:[d,z]},children:[{type:a,value:"'%'"}]},{type:a,value:" foobarbaz\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"NOTE: My salt states script creates a grain in "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fetc\u002Fsalt\u002Fgrains"}]},{type:a,value:" with the\nfollowing data;"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,Y]},children:[{type:b,tag:i,props:{},children:[{type:b,tag:c,props:{className:[d,j,m]},children:[{type:a,value:"roles"}]},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:k}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,f]},children:[{type:a,value:h}]},{type:a,value:" masterdb\n"}]}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Alternatively, you could call the VM "},{type:b,tag:i,props:{},children:[{type:a,value:"db1-masterdb"}]},{type:a,value:", use a "},{type:b,tag:n,props:{href:cS,rel:[p,q,r],target:s},children:[{type:a,value:"small python script\nthat'll parse the information for you and make it a "},{type:b,tag:M,props:{},children:[{type:a,value:"grain"}]},{type:a,value:"\nautomatically"}]},{type:a,value:". 8. "},{type:b,tag:M,props:{},children:[{type:a,value:"Back to the masterdb VM"}]},{type:a,value:", check if the user exists,\nensure SSL is required"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,av]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"MariaDB [(none)]\u003E show grants for 'replication_user';\n\u003E +---------------------------------------------------------------------------------------+\n\u003E | Grants for replication_user@%                                                         |\n\u003E +---------------------------------------------------------------------------------------+\n\u003E | GRANT REPLICATION SLAVE ON *.* TO 'replication_user'@'%' IDENTIFIED BY PASSWORD '...' |\n\u003E +---------------------------------------------------------------------------------------+\n\nMariaDB [(none)]\u003E GRANT REPLICATION SLAVE ON *.* TO 'replication_user'@'%.local.wpdn' REQUIRE SSL;\nMariaDB [(none)]\u003E GRANT USAGE ON *.* TO 'replication_user'@'%' REQUIRE SSL;\n\nMariaDB [(none)]\u003E SELECT User,Host,Repl_slave_priv,Repl_client_priv,ssl_type,ssl_cipher from mysql.user where User = 'replication_user';\n\u003E +------------------+--------------+-----------------+------------------+----------+\n\u003E | User             | Host         | Repl_slave_priv | Repl_client_priv | ssl_type |\n\u003E +------------------+--------------+-----------------+------------------+----------+\n\u003E | replication_user | %.local.wpdn | Y               | N                | ANY      |\n\u003E +------------------+--------------+-----------------+------------------+----------+\n"}]}]}]},{type:a,value:e},{type:b,tag:N,props:{start:9},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"On the secondary db VM, in mysql prompt, setup the initial "},{type:b,tag:i,props:{},children:[{type:a,value:"CHANGE MASTER"}]},{type:a,value:"\nstatement;"}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,av]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"CHANGE MASTER TO\n  MASTER_HOST='masterdb.local.wpdn',\n  MASTER_USER='replication_user',\n  MASTER_PASSWORD='foobarbaz',\n  MASTER_PORT=3306,\n  MASTER_LOG_FILE='mariadbrepl-bin.000002',\n  MASTER_LOG_POS=644,\n  MASTER_CONNECT_RETRY=10,\n  MASTER_SSL=1,\n  MASTER_SSL_CA='\u002Fetc\u002Fmysql\u002Fca-cert.pem',\n  MASTER_SSL_CERT='\u002Fetc\u002Fmysql\u002Fclient-cert.pem',\n  MASTER_SSL_KEY='\u002Fetc\u002Fmysql\u002Fclient-key.pem';\n"}]}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:aa,props:{id:dc},children:[{type:b,tag:n,props:{href:"#checking-if-it-worked",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:dd}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"From one of the secondary servers, look for success indicators:"}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"Seconds_Behind_Master"}]},{type:a,value:dV},{type:b,tag:M,props:{},children:[{type:a,value:bU}]},{type:a,value:ao}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"Slave_IO_State"}]},{type:a,value:dV},{type:b,tag:M,props:{},children:[{type:a,value:"Waiting for master to send event"}]}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,av]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"MariaDB [wpstats]\u003E show slave status\\G\n*************************** 1. row ***************************\n               Slave_IO_State: Waiting for master to send event\n                  Master_Host: masterdb.local.wpdn\n                  Master_User: replication_user\n                  Master_Port: 3306\n                Connect_Retry: 10\n              Master_Log_File: mariadbrepl-bin.000066\n          Read_Master_Log_Pos: 19382112\n               Relay_Log_File: mariadbrepl-relay-bin.000203\n                Relay_Log_Pos: 19382405\n        Relay_Master_Log_File: mariadbrepl-bin.000066\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n              Replicate_Do_DB:\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: 0\n                   Last_Error:\n                 Skip_Counter: 0\n          Exec_Master_Log_Pos: 19382112\n              Relay_Log_Space: 19382757\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: 0\n           Master_SSL_Allowed: Yes\n           Master_SSL_CA_File: \u002Fetc\u002Fmysql\u002Fca-cert.pem\n           Master_SSL_CA_Path:\n              Master_SSL_Cert: \u002Fetc\u002Fmysql\u002Fclient-cert.pem\n            Master_SSL_Cipher:\n               Master_SSL_Key: \u002Fetc\u002Fmysql\u002Fclient-key.pem\n        Seconds_Behind_Master: 0\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: 0\n                Last_IO_Error:\n               Last_SQL_Errno: 0\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: 1\n               Master_SSL_Crl: \u002Fetc\u002Fmysql\u002Fca-cert.pem\n           Master_SSL_Crlpath:\n                   Using_Gtid: No\n                  Gtid_IO_Pos:\n      Replicate_Do_Domain_Ids:\n  Replicate_Ignore_Domain_Ids:\n1 row in set (0.00 sec)\n"}]}]}]},{type:a,value:e}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:aa,props:{id:de},children:[{type:b,tag:n,props:{href:"#managing-users",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:df}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"In the end, since replication is active, you can add users to your system and\nall nodes will get the privileges."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The way I work is that I can use Salt stack states to add privileges in my\nstates (more details soon) or I can use a few salt commands from my salt master\nand send them to the database "},{type:b,tag:i,props:{},children:[{type:a,value:bx}]},{type:a,value:" VM."}]},{type:a,value:e},{type:b,tag:v,props:{className:[w]},children:[{type:b,tag:t,props:{className:[x,av]},children:[{type:b,tag:i,props:{},children:[{type:a,value:"salt -G 'roles:masterdb' mysql.db_create 'accounts_oauth' 'utf8' 'utf8_general_ci'\nsalt -G 'roles:masterdb' mysql.user_create 'accounts' '%' 'barfoo'\nsalt -G 'roles:masterdb' mysql.grant_add 'ALL PRIVILEGES' 'accounts_oauth.*' 'accounts' ‘%’\n"}]}]}]},{type:a,value:e},{type:b,tag:aa,props:{id:dg},children:[{type:b,tag:n,props:{href:"#references",ariaHidden:A,tabIndex:H},children:[{type:b,tag:c,props:{className:[I,J]},children:[]}]},{type:a,value:a$}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:dW,rel:[p,q,r],target:s},children:[{type:a,value:dW}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:dX,rel:[p,q,r],target:s},children:[{type:a,value:dX}]}]},{type:a,value:e}]},{type:a,value:e}]},dir:cT,path:"\u002Fblog\u002F2015\u002F01\u002Fcreate-mariadb-cluster-replication-ssl-salt-stack",extension:al,slug:"create-mariadb-cluster-replication-ssl-salt-stack",createdAt:a_,updatedAt:a_,category:am,prettyfiedTemporalDate:{prettified:"Wednesday, January 28, 2015",temporalDate:"2015-01-28"}},{locale:cF,title:"Processus de création d'une VM faisant partie d'un parc géré par Salt Stack",canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2014\u002F01\u002Fprocessus-de-creation-dune-vm-faisant-partie-dun-parc-gere-par-salt-stack\u002F",status:aj,revising:O,caption:B,gallery:B,migrateCode:O,migrateImages:O,migrateLinks:O,created:"2014-01-22",updated:"2015-03-09",categories:[],tags:[as,dY,"best-practices","logiciel-libre",ab],description:"Processus de création d'une VM faisant partie d'un parc Salt stack",coverImage:{src:"~\u002Fassets\u002Fcontent\u002Fblog\u002F2014\u002F01\u002Fsalt-spill-300x280.jpg",srcset:["~\u002Fassets\u002Fcontent\u002Fblog\u002F2014\u002F01\u002Fsalt-spill-300x280.jpg 300w","~\u002Fassets\u002Fcontent\u002Fblog\u002F2014\u002F01\u002Fsalt-spill.jpg 310w"],sizes:cI,alt:"Une salière a coté d’un déversement de sel, avec le mot sel écrit en anglais."},excerpt:"Voici une courte procédure décrivant comment je crée une nouvelle machine virtuelle et y applique les configurations automatiquement.",toc:[{depth:Q,text:dZ}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"A mon "},{type:b,tag:d_,props:{title:"I am joining the W3C to work on WebPlatform.org!",to:"\u002Fblog\u002F2013\u002F08\u002Fi-am-joining-w3c-to-work-on-the-webplatform-project\u002F"},children:[{type:a,value:"emploi "},{type:b,tag:R,props:{},children:[{type:a,value:"actuel"}]}]},{type:a,value:" je gère un parc de machines virtuelles (VMs) qui est automatisé par un système de gestion de configuration appelé "},{type:b,tag:M,props:{},children:[{type:b,tag:n,props:{href:d$,title:ea},children:[{type:a,value:bb}]}]},{type:a,value:ak}]},{type:a,value:e},{type:b,tag:bp,props:{},children:[{type:a,value:L},{type:b,tag:g,props:{},children:[{type:b,tag:n,props:{href:d$,title:ea},children:[{type:a,value:"Salt stack"}]},{type:a,value:" est un outil permettant de décrire quel est l’état désiré d’un serveur. Comme d’autres outils avec une utilité similaire, "},{type:b,tag:R,props:{},children:[{type:a,value:bb}]},{type:a,value:" peut être utilisé dans des "},{type:b,tag:R,props:{},children:[{type:a,value:"environnements hétérogènes"}]},{type:a,value:" sous "},{type:b,tag:M,props:{},children:[{type:a,value:"GNU\u002FLinux"}]},{type:a,value:aL},{type:b,tag:M,props:{},children:[{type:a,value:"Mac OS"}]},{type:a,value:", et "},{type:b,tag:M,props:{},children:[{type:a,value:"Windows"}]},{type:a,value:aL},{type:b,tag:M,props:{},children:[{type:a,value:"FreeBSD"}]},{type:a,value:", etc."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"L’environment que nous utilisons est un serveur avec des «blades». Chaque «blade» fournit les services créant un cluster OpenStack. Dans le futur, nous risquons d'avoir plus d'un fournisseur OpenStack. Pour automatiser comme nous l'aimons, nous utilisons grandement la ligne de commande avec le paquet "},{type:b,tag:i,props:{},children:[{type:a,value:bu}]},{type:a,value:ak}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Chaque machine virtuelle roule une version "},{type:b,tag:R,props:{},children:[{type:a,value:eb}]},{type:a,value:" («Long Term Support») de Ubuntu."}]},{type:a,value:e},{type:b,tag:bp,props:{},children:[{type:a,value:L},{type:b,tag:g,props:{},children:[{type:a,value:"Absolument toutes les configurations sont appliqués via "},{type:b,tag:R,props:{},children:[{type:a,value:bb}]},{type:a,value:", la seule chose qui est fait manuellement en\n  ce moment est de créer la nouvelle instance, et de l'ajouter au «master» de Salt Stack."}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Même là, ça risque de changer lorsque nous aurons déployé "},{type:b,tag:n,props:{href:"http:\u002F\u002Fwww.saltstack.com\u002Fsalt-cloud\u002F",title:"Salt Cloud, a Salt Stack component specialized in helping automating cloud deployment"},children:[{type:a,value:"Salt Cloud"}]},{type:a,value:ak}]},{type:a,value:e},{type:b,tag:X,props:{},children:[{type:a,value:dZ}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:M,props:{},children:[{type:a,value:"Mise à jour Mars 2015"}]},{type:a,value:": "},{type:b,tag:R,props:{},children:[{type:a,value:"Un nouvel article sur le même sujet"}]},{type:a,value:" a été écrit (en anglais) et illustre "},{type:b,tag:d_,props:{title:"Creating a new Ubuntu salt-master from the terminal using Cloud-Init",to:"\u002Fblog\u002F2015\u002F03\u002Fcreating-new-ubuntu-salt-master-terminal-using-cloud-init\u002F"},children:[{type:a,value:"comment faire une nouvelle VM avec encore moins d’étapes"}]}]},{type:a,value:e},{type:b,tag:N,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Boot une nouvelle node avec Nova"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"joe@master:~$ nova boot --image lucid-minion-template --flavor wpdn.large --key-name renoirb app6\n"}]}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Donner un nom en fonction du type de serveur a déployer avec un numéro à la fin. Exemple: "},{type:b,tag:i,props:{},children:[{type:a,value:"app6"}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:b,tag:R,props:{},children:[{type:a,value:"NOTE"}]},{type:a,value:" Dans mon cas, j'ai notamment: app, db, memcached, etc."}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Ajoute l'adresse floating dans "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fsrv\u002Fpillar\u002Fnodes\u002Finit.sls"}]},{type:a,value:" comme les autres"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"nodes:\n  master:\n    public:  ####IP PUBLIQUE CACHÉE####\n    private: 10.0.0.1\n\n  app1:\n    public:  ####IP PUBLIQUE CACHÉE####\n    private: 10.0.0.7\n\n  memcache2:\n    public:  ####IP PUBLIQUE CACHÉE####\n    private: 10.0.0.4\n\n  app5:\n    public:  ####IP PUBLIQUE CACHÉE####\n    private: 10.0.0.3\n"}]}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Prend le fichier "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fhome\u002Fubuntu\u002Frunme"}]},{type:a,value:" de n'importe quel autre serveur et colle le dans la nouvelle machine. Puis execute ("},{type:b,tag:i,props:{},children:[{type:a,value:"sudo \u002Fbin\u002Fbash runme"}]},{type:a,value:ap}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Ajouter une ligne dans le nouveau serveir dans "},{type:b,tag:i,props:{},children:[{type:a,value:"\u002Fetc\u002Fsalt\u002Fminion.d\u002Fmaster.conf"}]}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"id: app6\n"}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"... Voir les autres nodes"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Restart salt-minion"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"ubuntu@node6:~$ sudo service salt-minion restart\n"}]}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Ajoute la clée au master"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"joe@master:~$ sudo salt-key -a app6\n"}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"... Le '-a foo' est optionnel et tu peux lister Les nodes."}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Run state.highstate"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"joe@master:~$ sudo salt app6 state.highstate\n"}]}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Uploader le code via rsync dans la nouvelle app node, puis re-rouler state.highstate (certains scripts prennent pour aquis que le code est déjà déployé)"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"joe@master:~$ sudo salt app6 state.sls code.node_app\njoe@master:~$ sudo salt app6 state.highstate\n"}]}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Comme je disais, parfois, le premier "},{type:b,tag:i,props:{},children:[{type:a,value:dz}]},{type:a,value:" ne marche pas a cause du code pas déployé."}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Rafraichir les autorisations pour storage"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"joe@master:~$ sudo salt 'storage*' state.highstate\njoe@master:~$ sudo salt 'monitor*' state.highstate\n"}]}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Updater le hosts file de quelque nodes"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"joe@master:~$ sudo salt 'app*' state.sls hosts\njoe@master:~$ sudo salt 'db*' state.sls hosts\njoe@master:~$ sudo salt 'memcache*' state.sls hosts\n"}]}]}]},{type:a,value:e}]},{type:a,value:e}]},dir:"\u002Fblog\u002F2014\u002F01",path:"\u002Fblog\u002F2014\u002F01\u002Fprocessus-de-creation-dune-vm-faisant-partie-dun-parc-gere-par-salt-stack",extension:al,slug:"processus-de-creation-dune-vm-faisant-partie-dun-parc-gere-par-salt-stack",createdAt:bc,updatedAt:bc,category:ec,prettyfiedTemporalDate:{prettified:"mercredi 22 janvier 2014",temporalDate:"2014-01-22"}},{locale:ar,title:"Project idea: Creating a home made OpenStack cluster for development purposes",canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2013\u002F10\u002Fproject-idea-creating-a-home-made-openstack-cluster-for-development-purposes\u002F",status:aj,revising:O,created:"2013-10-24",updated:ed,tags:[as,cH,dY,aH,ab],categories:[ee],coverImage:{src:"~\u002Fassets\u002Fcontent\u002Fblog\u002F2013\u002F10\u002Fcomputercloud-218x300.jpg",srcset:["~\u002Fassets\u002Fcontent\u002Fblog\u002F2013\u002F10\u002Fcomputercloud-218x300.jpg 218w","~\u002Fassets\u002Fcontent\u002Fblog\u002F2013\u002F10\u002Fcomputercloud.jpg 462w"],sizes:"(max-width: 218px) 100vw, 218px",alt:"Decorative image of a laptop floating in front of a cloudy sky."},description:"The idea of the project is to give an alternate life to a mostly unused laptops a second life.",excerpt:"At work, I use an OpenStack environment and a few Salt states to manage a set of virtual machines. I'd like to give another life to two old laptops that spend most of their time shut down, but without changing or using their local hard drives.",toc:[{depth:W,text:ef},{depth:W,text:eg},{depth:W,text:eh},{depth:W,text:ei},{depth:W,text:ej}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"Think about it. How about using spare computers to create a homemade OpenStack cluster for development."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"We can do that from our cloud provider, or create a separate project or even use Wikimedia's OpenStack infrastructure allowance for the project."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"With such setup, one could work locally with his Salt stack (or Puppet, or Ansible) deployment schemes, try them, trash "},{type:b,tag:aG,props:{},children:[{type:a,value:"VMs"}]},{type:a,value:", rebuild."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"The beauty of it would be that it could be made in a fashion that would not even modify the computer running the VMs. The cluster member running OpenStack hypervisor would be installed seeded through net boot. Not booting from the network would revert the computer back as if it never been used."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Here is what I think would require to make this happen."}]},{type:a,value:e},{type:b,tag:aa,props:{},children:[{type:a,value:ef}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Not use Computer\u002FLaptop local hard drive"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Rely only on net boot"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:aa,props:{},children:[{type:a,value:eg}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"1..n Computers\u002Flaptop supporting netboot"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"1 Storage device supporting one or more storage protocol ("},{type:b,tag:aG,props:{},children:[{type:a,value:"nfs"}]},{type:a,value:", samba, "},{type:b,tag:aG,props:{},children:[{type:a,value:"sshfs"}]},{type:a,value:ap}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:aa,props:{},children:[{type:a,value:eh}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:ek},{type:b,tag:aG,props:{},children:[{type:a,value:el}]},{type:a,value:" providing tftp, dhcp, dns to serve as net boot server that should run outide of the cluster (\"Networking node\")"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:ek},{type:b,tag:aG,props:{},children:[{type:a,value:el}]},{type:a,value:" image of OpenStack controller (\"OpS controller\")"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"1 LiveCD+persistent image with OpenStack preinstalled, configured to use storage device credentials as it's root filesystem (\"OpS Hypervisor\")"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:aa,props:{},children:[{type:a,value:ei}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"Networking node can be the smallest Linux possible, on a RaspberryPI, or a modified Router or Network Attached storage device?"}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:a,value:"OpS Hypervisor to be among the supported OpenStack distributions (I think a Ubuntu precise 12.04 "},{type:b,tag:aG,props:{},children:[{type:a,value:eb}]},{type:a,value:" or a variant such as Puppy Linux might work too)"}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:aa,props:{},children:[{type:a,value:ej}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"I will keep you posted whenever possible on the outcome of my research."}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Did you ever do this in your infra. Leave a comment."}]}]},dir:"\u002Fblog\u002F2013\u002F10",path:"\u002Fblog\u002F2013\u002F10\u002Fproject-idea-creating-a-home-made-openstack-cluster-for-development-purposes",extension:al,slug:"project-idea-creating-a-home-made-openstack-cluster-for-development-purposes",createdAt:bc,updatedAt:bc,category:ee,prettyfiedTemporalDate:{prettified:"Thursday, October 24, 2013",temporalDate:"2013-10-24"}},{locale:ar,title:"How to create a patch and ensure it is applied within Salt Stack",canonical:"https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2013\u002F09\u002Fhow-to-create-a-patch-and-ensure-it-is-applied-within-salt-stack\u002F",status:aj,revising:O,migrateCode:O,migrateLinks:O,created:"2013-09-12",updated:ed,tags:[ab,cV],categories:[],description:"This tutorial shows how to create a patch, sign it, and make sure it is applied.",excerpt:"When you need to adjust a file with a specific code modification and you are sure the file will not change over time, patch is a viable solution. This tutorial shows how to create a patch, sign it, and make sure it is applied.",toc:[{depth:W,text:ay},{depth:W,text:a$}],body:{type:ae,children:[{type:b,tag:g,props:{},children:[{type:a,value:"Quick tutorial on how to create a patch and ensure it is applied using "},{type:b,tag:n,props:{href:"https:\u002F\u002Fsaltproject.io\u002F"},children:[{type:a,value:"salt stack"}]},{type:a,value:ak}]},{type:a,value:e},{type:b,tag:aa,props:{},children:[{type:a,value:ay}]},{type:a,value:e},{type:b,tag:em,props:{},children:[{type:a,value:"Creating a patch"}]},{type:a,value:e},{type:b,tag:N,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Create a copy of original file"}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"cp file file.orig"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Modify file, and test"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Create a md5 sum of the modified file for later use"}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"cat file | md5sum"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Revert modification, then prepare patch"},{type:b,tag:en,props:{},children:[]},{type:a,value:"\nmv file file.mod"},{type:b,tag:en,props:{},children:[]},{type:a,value:"\ncp file.orig file"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:g,props:{},children:[{type:a,value:"Create diff"}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"diff -Naur file file.mod \u003E file.patch\n"}]}]}]},{type:a,value:e}]},{type:a,value:e},{type:b,tag:em,props:{},children:[{type:a,value:"Create Salt stack manifest block in appropriate state file"}]},{type:a,value:e},{type:b,tag:g,props:{},children:[{type:a,value:"Add a block similar to this as a patch state definition. Make sure it is refered at least in your "},{type:b,tag:i,props:{},children:[{type:a,value:"top.sls"}]}]},{type:a,value:e},{type:b,tag:t,props:{},children:[{type:b,tag:i,props:{},children:[{type:a,value:"    \u002Fusr\u002Fshare\u002Fganglia-webfrontend\u002Fauth.php:\n      file.patch:\n        - source: salt:\u002F\u002Fmonitor\u002Fauth.php.patch\n        - hash: md5=480ef2ae17fdfee85585ab887fa1ae5f\n"}]}]},{type:a,value:e},{type:b,tag:aa,props:{},children:[{type:a,value:a$}]},{type:a,value:e},{type:b,tag:U,props:{},children:[{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"http:\u002F\u002Fdocs.saltstack.com\u002Fref\u002Fstates\u002Fall\u002Fsalt.states.file.html#salt.states.file.patch"},children:[{type:a,value:"Salt stack states.file.patch"}]}]},{type:a,value:e},{type:b,tag:l,props:{},children:[{type:b,tag:n,props:{href:"http:\u002F\u002Fjungels.net\u002Farticles\u002Fdiff-patch-ten-minutes.html"},children:[{type:a,value:"diff patch in ten minutes"}]}]},{type:a,value:e}]}]},dir:"\u002Fblog\u002F2013\u002F09",path:"\u002Fblog\u002F2013\u002F09\u002Fhow-to-create-a-patch-and-ensure-it-is-applied-within-salt-stack",extension:al,slug:"how-to-create-a-patch-and-ensure-it-is-applied-within-salt-stack",createdAt:eo,updatedAt:eo,category:ec,prettyfiedTemporalDate:{prettified:"Thursday, September 12, 2013",temporalDate:"2013-09-12"}}],taxonomyKey:ab,taxonomy:{key:ab,human:{key:ab,text:bb,description:"Essais écrits lors de mes expérimentations avec SaltStack, l’outil de\ngestion de déploiement par SaltStack Inc. maintenant acquis par VMWare\n"}}}],fetch:[],mutations:void 0}}("text","element","span","token","\n","punctuation","p","-","code","key",":","li","atrule","a"," ","nofollow","noopener","noreferrer","_blank","pre","operator","div","nuxt-content-highlight","line-numbers","\u003E","string","true",false,"\n    ","\\","{","}","|",-1,"icon","icon-link","language-bash","\n  ","strong","ol",true,"number",2,"em","parameter","variable","ul","---",3,"h2","language-yaml","function","comment","\n      ","h3","salt-stack","=","\n        ","root","boolean","attr-name","value","attr-value","publish",".",".md","projects","important",",",")","     ","en-CA","cloud-computing","[","]","language-text","name","unchanged","Procedure","Cloud-Init","\n     ","define","(","single-quoted-string","double-quoted-string",";","abbr","linux","prefix","line","procedure",", "," salt","snippet","cmd.run","unless","user"," dir "," grep ","q ","2024-10-24T19:50:04.930Z","https:\u002F\u002Fcloudinit.readthedocs.org\u002Fen\u002Flatest\u002F","Cloud-Init reference documentation pages","https:\u002F\u002Fwww.digitalocean.com\u002Fcommunity\u002Ftutorials\u002Fan-introduction-to-cloud-config-scripting","false","nova","2024-10-24T19:50:04.929Z","References"," apt","Salt Stack","2024-10-24T19:50:04.927Z","operations","0000","1","curl","2023-02-18T00:00:00.000Z","aufs","%","\n\n","require","pkg"," ubuntu\n    ","An introduction to cloud-config scripting","blockquote","--image"," Ubuntu-14.04-Trusty ","--key_name","--flavor","python-novaclient","https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002F563cb12326b92b22a452","10.10","masterdb","2014.7","salt ","-G","bind-address","~\u002Fassets\u002Fcontent\u002Fblog\u002F2015\u002F05\u002Fwebplatform-openstack-cluster-2014-10-06.png","get-openstack-instance-detail-using-salt","Get OpenStack instance detail using Salt","what-data-you-can-get","What data you can get","what-does-the-script-do","What does the script do?","install","Install","https:\u002F\u002Fgithub.com\u002Fsaltstack\u002Fsalt-contrib\u002Fblob\u002Fmaster\u002Fgrains\u002Fec2_info.py","The ","security-groups","7c55","4dd3","a00000000000\n","app1","availability_zone","\n            vda\n        ","0","...","\n        None\n    ","http:\u002F\u002Fdocs.openstack.org\u002Fadmin-guide-cloud\u002Fcontent\u002Fsection_metadata-service.html"," (","coord","inserted","2024-10-24T19:50:04.932Z","docker"," and ","#procedure"," https","file.managed","service"," linux","pkg.installed"," git\n  ","group",4,"* state.highstate\n","2024-10-24T19:50:04.931Z","GNU","A common task while writing server configuration management manifests is to make sure that some enforcements are run in specific situations.","add-group-additional-membership-to-user","Add group additional membership to user","change-ownership-on-a-folder-only-if-its-not-what-we-expect","usermod -a -G amavis clamav","\u002Fblog\u002F2015\u002F03","read-more","Read more","app-image","float:unset;","Easily automate The provisioning of your DigitalOcean Droplets ... using Cloud-Init","2013","#cloud-config","nova boot ","\n     --security-groups default ","\u002Fsrv\u002Fcloudconfig.yml","\u002Fetc\u002Fprofile.d\u002F","fr-CA","2015-01-28T00:00:00.000Z","development","(max-width: 300px) 100vw, 300px","requis","Requis","bouts-de-code","Bouts de code","billets-inspirants-sur-le-sujet","Billets inspirants sur le sujet","https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F01\u002Fcreate-mariadb-cluster-replication-ssl-salt-stack\u002F","https:\u002F\u002Fgist.github.com\u002FWebPlatformDocs\u002F780307ff289864ba02f5","https:\u002F\u002Fgist.github.com\u002Frenoirb\u002Fa66b533c46ef7a8de8e3","https:\u002F\u002Fgist.github.com\u002Frenoirb\u002Fb2e0222ad52e5d453298","\u002Fblog\u002F2015\u002F01","Create a MariaDB cluster with replication over SSL with Salt Stack","techniques","changing-mariadb-replication-master","Changing MariaDB replication master","assumptions","Assumptions","from-the-salt-master-initiate-a-few-vms-to-use-for-your-database-cluster","From the salt-master, initiate a few VMs to use for your database cluster","now-on-each-database-server","Now on each database server;","checking-if-it-worked","Checking if it worked","managing-users","Managing users","references","userdata.txt","app-alert-box","While migrating this article...","get "," renoirb-production ","-y","-a","..",". "," ACTIVE  "," Running     "," private-network","hosts_entries"," www","data\n    ","'pillar.get'","language-php","  ","state.highstate","'roles:db'"," db2:\n","10.1",".2-MariaDB-1~trusty-wsrep-log\n"," db1-masterdb:\n","     ca-cert.pem\n","     ca-key.pem\n","     client-cert.pem\n","     client-key.pem\n","     client-req.pem\n","     server-cert.pem\n","     server-key.pem\n","     server-req.pem\n","ssh","server_id","section","section-name","selector","\nssl\n","ssl-cert","ssl-key"," says ","http:\u002F\u002Fdev.mysql.com\u002Fdoc\u002Frefman\u002F5.7\u002Fen\u002Freplication-solutions-ssl.html","https:\u002F\u002Fmariadb.com\u002Fkb\u002Fen\u002Fmariadb\u002Fdocumentation\u002Fmanaging-mariadb\u002Freplication\u002Fstandard-replication\u002Fsetting-up-replication\u002F","favourites","Procédure","nuxt-link","http:\u002F\u002Fwww.saltstack.com\u002Fcommunity\u002F","Salt Stack, The Salt Open Source Software Project","LTS","","2014-02-04","projets","Limitations","Material","Hardware requirements","Distribution choice factors","To be continued...","1 ","VM","h4","br","2024-10-24T19:50:04.926Z")));