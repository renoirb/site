__NUXT_JSONP__("/blog/2015/04/install-discourse-docker-ubuntu-14-04-aufs-enabled", (function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,_,$,aa,ab,ac,ad,ae,af){return {data:[{},{},{},{canonical:P,content:{title:"Install Discourse and Docker on Ubuntu 14.04 with aufs enabled",locale:F,created:"2015-04-02T00:00:00.000Z",updated:"2023-02-18T00:00:00.000Z",canonical:P,status:"publish",revising:true,categories:[Q],tags:["standardization","salt-stack",G],keywords:[R,"discourse",H,"ubuntu","makefile"],excerpt:"I needed to install a set of VMs to run apps within Docker containers. In the case of Discourse, docker requires you to use aufs instead of devicemapper.",toc:[{id:G,depth:S,text:T}],body:{type:I,children:[{type:b,tag:o,props:{},children:[{type:a,value:"While working to run "},{type:b,tag:p,props:{href:"https:\u002F\u002Fwww.discourse.org\u002F",rel:[q,r,s],target:t},children:[{type:a,value:"Discourse"}]},{type:a,value:" on "},{type:b,tag:p,props:{href:"https:\u002F\u002Fwww.docker.com\u002F",rel:[q,r,s],target:t},children:[{type:a,value:"Docker"}]},{type:a,value:" I was getting numerous errors\nabout a mount problem related to device mapper."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"If you are using Ubuntu 14.04 LTS, want to solve the problem with aufs, and use\nSalt Stack to control your VMs, here's how I did it."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"After digging "},{type:b,tag:p,props:{href:"https:\u002F\u002Fmeta.discourse.org\u002Ft\u002Fdocker-error-on-bootstrap\u002F13657\u002F9",rel:[q,r,s],target:t},children:[{type:a,value:"for"}]},{type:a,value:k},{type:b,tag:p,props:{href:"https:\u002F\u002Fmeta.discourse.org\u002Ft\u002Fubuntu-updates-intefere-with-docker-and-aufs\u002F25039",rel:[q,r,s],target:t},children:[{type:a,value:"some"}]},{type:a,value:" time, I found others who had also problems to\nrun Discourse in Docker, and that we had to use \"aufs\"."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"I had no idea that we could use different mount subsystems in Docker."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"So I had to read some more on we can find out if we have "},{type:b,tag:l,props:{},children:[{type:a,value:H}]},{type:a,value:" (whatever this\nis), and that we can tell whether or not Docker is configured to use it."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"The "},{type:b,tag:p,props:{href:"https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdocker\u002Fissues\u002F10161",rel:[q,r,s],target:t},children:[{type:a,value:"issue docker\u002Fdocker#10161"}]},{type:a,value:" had proven very helpful to figure out what\nwas my problem. I never thought I could tell Docker to use another device mapper\nengine anyway. In the end, all you can do is to add a "},{type:b,tag:l,props:{},children:[{type:a,value:"-s foo"}]},{type:a,value:" and it can change\nthe Storage engine."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"Turns out that "},{type:b,tag:l,props:{},children:[{type:a,value:H}]},{type:a,value:" is a Kernel module, and that latest Ubuntu 14.04 has it\n"},{type:b,tag:p,props:{href:"https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdocker\u002Fpull\u002F10860",rel:[q,r,s],target:t},children:[{type:a,value:"but not in the default kernel package"}]},{type:a,value:". You have to make sure that\n"},{type:b,tag:l,props:{},children:[{type:a,value:"linux-image-extra-virtual"}]},{type:a,value:" and "},{type:b,tag:l,props:{},children:[{type:a,value:"aufs-tools"}]},{type:a,value:" are installed."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"Documentation and notes recommends to download and "},{type:b,tag:p,props:{href:"https:\u002F\u002Fget.docker.com\u002F",rel:[q,r,s],target:t},children:[{type:a,value:"run a shell script"}]},{type:a,value:" to\ninstall Docker instead of using the distribution packages. But I refuse to\nfollow this advice because I already manage via Salt stack every components of\nthe infrastructure. I just needed to put the right pieces together."}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"Since those changes are specific to Discourse I didn't wanted to make a pull\nrequest to "},{type:b,tag:p,props:{href:"https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fdocker-formula",rel:[q,r,s],target:t},children:[{type:b,tag:"strong",props:{},children:[{type:a,value:"saltstack-formulas\u002Fdocker-formula"}]}]},{type:a,value:" right away, i'd need to\n"},{type:b,tag:p,props:{href:"https:\u002F\u002Fdocs.saltstack.com\u002Fen\u002Flatest\u002Ftopics\u002Fdevelopment\u002Fconventions\u002Fformulas.html",rel:[q,r,s],target:t},children:[{type:a,value:"follow Salt formula conventions"}]},{type:a,value:" and add more logic for my PR to be usable\nby other server runtime too. Not something I had in my plans today."}]},{type:a,value:j},{type:b,tag:"h2",props:{id:G},children:[{type:b,tag:p,props:{href:"#procedure",ariaHidden:"true",tabIndex:-1},children:[{type:b,tag:c,props:{className:["icon","icon-link"]},children:[]}]},{type:a,value:T}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"On the salt master, make sure you have the following:"}]},{type:a,value:j},{type:b,tag:x,props:{},children:[{type:a,value:j},{type:b,tag:y,props:{},children:[{type:a,value:"Add "},{type:b,tag:l,props:{},children:[{type:a,value:"saltstack-formulas\u002Fdocker-forumla"}]},{type:a,value:" in your gitfs entries"}]},{type:a,value:j}]},{type:a,value:j},{type:b,tag:z,props:{className:[A]},children:[{type:b,tag:B,props:{className:[C,J]},children:[{type:b,tag:l,props:{},children:[{type:b,tag:c,props:{className:[d,K]},children:[{type:a,value:"# \u002Fetc\u002Fsalt\u002Fmaster.d\u002Fgitfs.conf"}]},{type:a,value:j},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"fileserver_backend"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:v},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" roots\n  "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" git\n\n"},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"gitfs_remotes"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:v},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:U},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:"\u002F\u002Fgithub.com\u002Fsaltstack"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"formulas\u002Fdocker"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"formula.git\n"}]}]}]},{type:a,value:j},{type:b,tag:x,props:{start:S},children:[{type:a,value:j},{type:b,tag:y,props:{},children:[{type:a,value:"Ensure you have "},{type:b,tag:l,props:{},children:[{type:a,value:R}]},{type:a,value:" in your base top file"}]},{type:a,value:j}]},{type:a,value:j},{type:b,tag:z,props:{className:[A]},children:[{type:b,tag:B,props:{className:[C,J]},children:[{type:b,tag:l,props:{},children:[{type:b,tag:c,props:{className:[d,K]},children:[{type:a,value:"# \u002Fsrv\u002Fsalt\u002Ftop.sls"}]},{type:a,value:j},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"base"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:v},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"'backend-discourse*'"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" discourse\n"}]}]}]},{type:a,value:j},{type:b,tag:x,props:{start:3},children:[{type:a,value:j},{type:b,tag:y,props:{},children:[{type:a,value:"Create add those lines in "},{type:b,tag:l,props:{},children:[{type:a,value:"\u002Fsrv\u002Fsalt\u002Fdiscourse\u002Finit.sls"}]}]},{type:a,value:j}]},{type:a,value:j},{type:b,tag:z,props:{className:[A]},children:[{type:b,tag:B,props:{className:[C,J]},children:[{type:b,tag:l,props:{},children:[{type:b,tag:c,props:{className:[d,K]},children:[{type:a,value:"# https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fdocker-formula"}]},{type:a,value:j},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:"% set kernelrelease = salt"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:"["}]},{type:b,tag:c,props:{className:[d,V]},children:[{type:a,value:"'grains.get'"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:"]"}]},{type:a,value:"('kernelrelease') "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:j},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" set dir = '\u002Fsrv\u002Fwebplatform\u002Fdiscourse' "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:L},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:W},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"include"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:v},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" docker\n\n"},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"\u002Fetc\u002Fdefault\u002Fdocker"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:v},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"file.managed"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"contents"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:"|"}]},{type:b,tag:c,props:{className:[d,"scalar",V]},children:[{type:a,value:"\n        # Docker Upstart and SysVinit configuration file\n        #\n        # Managed by Salt Stack, at {{ source }}. Do NOT edit manually!\n        # Docker dependencies: Refer to the script at https:\u002F\u002Fget.docker.com\u002F\n        # Available cli options: http:\u002F\u002Fdocs.docker.com\u002Freference\u002Fcommandline\u002Fcli\u002F\n        DOCKER_OPTS=\"--dns 8.8.8.8 -s aufs\""}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"watch_in"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:X}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:" docker"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"service\n    "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:Y}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:M}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:" lxc"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"docker\n      "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:M}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:Z},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"kernel"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"deps\n\n"},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"linux-kernel-deps"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:v},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:_}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"pkgs"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:Z},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"image"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"extra"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:" kernelrelease "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" aufs"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"tools\n  "},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"cmd.run"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:D}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:" modprobe aufs\n    "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:$}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:" modinfo aufs "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:aa}]},{type:a,value:" \u002Fdev\u002Fnull 2"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:aa}]},{type:b,tag:c,props:{className:[d,"important"]},children:[{type:a,value:"&1"}]},{type:a,value:W},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"clone-discourse"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:v},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:_}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:D}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:ab},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"git.latest"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:D}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:U},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:"\u002F\u002Fgithub.com\u002Fdiscourse\u002Fdiscourse_docker.git\n    "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:N},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"target"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:E},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:$}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:" test "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:"f "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:E},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:"\u002Fcontainers\u002Fapp.yml\n    "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:Y}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"file"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:E},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:M}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:ab},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"file.directory"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:D}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:m}]},{type:a,value:E},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:n}]},{type:a,value:u},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:ac}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:N},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"group"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:N},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:k},{type:b,tag:c,props:{className:[d,h,i]},children:[{type:a,value:"recurse"}]},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:g}]},{type:a,value:w},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" user\n      "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:f}]},{type:a,value:" group\n"}]}]}]},{type:a,value:j},{type:b,tag:x,props:{start:4},children:[{type:a,value:j},{type:b,tag:y,props:{},children:[{type:a,value:"Restart your salt master service, sync everything and run highstate"}]},{type:a,value:j}]},{type:a,value:j},{type:b,tag:z,props:{className:[A]},children:[{type:b,tag:B,props:{className:[C,"language-bash"]},children:[{type:b,tag:l,props:{},children:[{type:b,tag:c,props:{className:[d,"function"]},children:[{type:a,value:X}]},{type:a,value:" salt-master restart\nsalt "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:O}]},{type:a,value:"* saltutil.sync_all\nsalt "},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:O}]},{type:a,value:"* service.restart salt-minion\nsalt discourse-backend"},{type:b,tag:c,props:{className:[d,e]},children:[{type:a,value:O}]},{type:a,value:"* state.highstate\n"}]}]}]},{type:a,value:j},{type:b,tag:x,props:{start:5},children:[{type:a,value:j},{type:b,tag:y,props:{},children:[{type:a,value:"Go to the VM and run the installer"}]},{type:a,value:j}]},{type:a,value:j},{type:b,tag:o,props:{},children:[{type:a,value:"Note that as long as there is no "},{type:b,tag:l,props:{},children:[{type:a,value:"\u002Fsrv\u002Fwebplatform\u002Fdiscourse\u002Fcontainers\u002Fapp.yml"}]},{type:a,value:"\nthe states will update the git "},{type:b,tag:p,props:{href:"https:\u002F\u002Fgithub.com\u002Fdiscourse\u002Fdiscourse_docker",rel:[q,r,s],target:t},children:[{type:a,value:"repository to the latest version"}]},{type:a,value:". In my\nprojects, I make sure that salt also generates a configuration file with my\ncurrent environment details (e.g. DNS, Salt master, Redis, SMTP relay, Postgres'\nprivate IP addresses)."}]}]},text:"---\ntitle: Install Discourse and Docker on Ubuntu 14.04 with aufs enabled\nlocale: en-CA\ncreated: 2015-04-02\nupdated: 2023-02-18\ncanonical: 'https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F04\u002Finstall-discourse-docker-ubuntu-14-04-aufs-enabled\u002F'\nstatus: publish\nrevising: true\ncategories:\n  - projects\ntags:\n  - standardization\n  - salt-stack\n  - procedure\nkeywords:\n  - docker\n  - discourse\n  - aufs\n  - ubuntu\n  - makefile\nexcerpt: \u003E-\n  I needed to install a set of VMs to run apps within Docker containers. In the\n  case of Discourse, docker requires you to use aufs instead of devicemapper.\n---\n\nWhile working to run [Discourse][0] on [Docker][1] I was getting numerous errors\nabout a mount problem related to device mapper.\n\nIf you are using Ubuntu 14.04 LTS, want to solve the problem with aufs, and use\nSalt Stack to control your VMs, here's how I did it.\n\nAfter digging [for][2] [some][3] time, I found others who had also problems to\nrun Discourse in Docker, and that we had to use \"aufs\".\n\nI had no idea that we could use different mount subsystems in Docker.\n\nSo I had to read some more on we can find out if we have `aufs` (whatever this\nis), and that we can tell whether or not Docker is configured to use it.\n\nThe [issue docker\u002Fdocker\\#10161][4] had proven very helpful to figure out what\nwas my problem. I never thought I could tell Docker to use another device mapper\nengine anyway. In the end, all you can do is to add a `-s foo` and it can change\nthe Storage engine.\n\nTurns out that `aufs` is a Kernel module, and that latest Ubuntu 14.04 has it\n[but not in the default kernel package][5]. You have to make sure that\n`linux-image-extra-virtual` and `aufs-tools` are installed.\n\nDocumentation and notes recommends to download and [run a shell script][6] to\ninstall Docker instead of using the distribution packages. But I refuse to\nfollow this advice because I already manage via Salt stack every components of\nthe infrastructure. I just needed to put the right pieces together.\n\nSince those changes are specific to Discourse I didn't wanted to make a pull\nrequest to [**saltstack-formulas\u002Fdocker-formula**][7] right away, i'd need to\n[follow Salt formula conventions][8] and add more logic for my PR to be usable\nby other server runtime too. Not something I had in my plans today.\n\n## Procedure\n\nOn the salt master, make sure you have the following:\n\n1. Add `saltstack-formulas\u002Fdocker-forumla` in your gitfs entries\n\n```yaml\n# \u002Fetc\u002Fsalt\u002Fmaster.d\u002Fgitfs.conf\nfileserver_backend:\n  - roots\n  - git\n\ngitfs_remotes:\n  - https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fdocker-formula.git\n```\n\n2. Ensure you have `docker` in your base top file\n\n```yaml\n# \u002Fsrv\u002Fsalt\u002Ftop.sls\nbase:\n  'backend-discourse*':\n    - discourse\n```\n\n3. Create add those lines in `\u002Fsrv\u002Fsalt\u002Fdiscourse\u002Finit.sls`\n\n```yaml\n# https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fdocker-formula\n{% set kernelrelease = salt['grains.get']('kernelrelease') -%}\n{%- set dir = '\u002Fsrv\u002Fwebplatform\u002Fdiscourse' -%}\n\ninclude:\n  - docker\n\n\u002Fetc\u002Fdefault\u002Fdocker:\n  file.managed:\n    - contents: |\n        # Docker Upstart and SysVinit configuration file\n        #\n        # Managed by Salt Stack, at {{ source }}. Do NOT edit manually!\n        # Docker dependencies: Refer to the script at https:\u002F\u002Fget.docker.com\u002F\n        # Available cli options: http:\u002F\u002Fdocs.docker.com\u002Freference\u002Fcommandline\u002Fcli\u002F\n        DOCKER_OPTS=\"--dns 8.8.8.8 -s aufs\"\n    - watch_in:\n      - service: docker-service\n    - require:\n      - pkg: lxc-docker\n      - pkg: linux-kernel-deps\n\nlinux-kernel-deps:\n  pkg.installed:\n    - pkgs:\n      - linux-image-extra-{{ kernelrelease }}\n      - aufs-tools\n  cmd.run:\n    - name: modprobe aufs\n    - unless: modinfo aufs \u003E \u002Fdev\u002Fnull 2\u003E&1\n\nclone-discourse:\n  pkg.installed:\n    - name: git\n  git.latest:\n    - name: https:\u002F\u002Fgithub.com\u002Fdiscourse\u002Fdiscourse_docker.git\n    - user: ubuntu\n    - target: {{ dir }}\n    - unless: test -f {{ dir }}\u002Fcontainers\u002Fapp.yml\n    - require:\n      - file: {{ dir }}\n      - pkg: git\n  file.directory:\n    - name: {{ dir }}\n    - user: ubuntu\n    - group: ubuntu\n    - recurse:\n      - user\n      - group\n```\n\n4. Restart your salt master service, sync everything and run highstate\n\n```bash\nservice salt-master restart\nsalt \\* saltutil.sync_all\nsalt \\* service.restart salt-minion\nsalt discourse-backend\\* state.highstate\n```\n\n5. Go to the VM and run the installer\n\nNote that as long as there is no `\u002Fsrv\u002Fwebplatform\u002Fdiscourse\u002Fcontainers\u002Fapp.yml`\nthe states will update the git [repository to the latest version][9]. In my\nprojects, I make sure that salt also generates a configuration file with my\ncurrent environment details (e.g. DNS, Salt master, Redis, SMTP relay, Postgres'\nprivate IP addresses).\n\n[0]: https:\u002F\u002Fwww.discourse.org\u002F\n[1]: https:\u002F\u002Fwww.docker.com\u002F\n[2]: https:\u002F\u002Fmeta.discourse.org\u002Ft\u002Fdocker-error-on-bootstrap\u002F13657\u002F9\n[3]:\n  https:\u002F\u002Fmeta.discourse.org\u002Ft\u002Fubuntu-updates-intefere-with-docker-and-aufs\u002F25039\n[4]: https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdocker\u002Fissues\u002F10161\n[5]: https:\u002F\u002Fgithub.com\u002Fdocker\u002Fdocker\u002Fpull\u002F10860\n[6]: https:\u002F\u002Fget.docker.com\u002F\n[7]: https:\u002F\u002Fgithub.com\u002Fsaltstack-formulas\u002Fdocker-formula\n[8]:\n  https:\u002F\u002Fdocs.saltstack.com\u002Fen\u002Flatest\u002Ftopics\u002Fdevelopment\u002Fconventions\u002Fformulas.html\n[9]: https:\u002F\u002Fgithub.com\u002Fdiscourse\u002Fdiscourse_docker\n",dir:"\u002Fblog\u002F2015\u002F04",path:"\u002Fblog\u002F2015\u002F04\u002Finstall-discourse-docker-ubuntu-14-04-aufs-enabled",extension:".md",slug:ad,createdAt:ae,updatedAt:ae,category:Q},coverImage:{toc:[],body:{type:I,children:[]},text:af},month:"04",next:{title:"Upgrade to Python 2.7.9 on Ubuntu 14.04 LTS and make your own .deb package for deployment",locale:F,path:"\u002Fblog\u002F2015\u002F04\u002Fupgrade-python-2-7-9-ubuntu-14-04-lts-making-deb-package",slug:"upgrade-python-2-7-9-ubuntu-14-04-lts-making-deb-package"},preamble:{toc:[],body:{type:I,children:[]},text:af},prettyfiedTemporalDate:{prettified:"Thursday, April 2, 2015",temporalDate:"2015-04-02"},prev:{title:"A few useful GNU\u002FLinux truth tests while creating salt states",locale:F,path:"\u002Fblog\u002F2015\u002F03\u002Fuseful-gnulinux-truth-tests",slug:"useful-gnulinux-truth-tests"},slug:ad,year:"2015"}],fetch:[],mutations:void 0}}("text","element","span","token","punctuation","-",":","key","atrule","\n"," ","code","{","}","p","a","nofollow","noopener","noreferrer","_blank","\n    ","\n  ","\n      ","ol","li","div","nuxt-content-highlight","pre","line-numbers","name"," dir ","en-CA","procedure","aufs","root","language-yaml","comment","%","pkg"," ubuntu\n    ","\\","https:\u002F\u002Frenoirboulanger.com\u002Fblog\u002F2015\u002F04\u002Finstall-discourse-docker-ubuntu-14-04-aufs-enabled\u002F","projects","docker",2,"Procedure"," https","string","\n\n","service","require"," linux","pkg.installed","unless","\u003E"," git\n  ","user","install-discourse-docker-ubuntu-14-04-aufs-enabled","2024-10-24T19:43:51.724Z","")));