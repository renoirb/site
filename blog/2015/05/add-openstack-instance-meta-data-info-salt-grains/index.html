<!doctype html>
<html data-n-head-ssr class="layout--default zone__sandwich light-mode" lang="en-CA" data-n-head="%7B%22class%22:%7B%22ssr%22:%5B%22layout--default%22,%22zone__sandwich%22,%22light-mode%22%5D%7D,%22lang%22:%7B%22ssr%22:%22en-CA%22%7D%7D">
  <head>
    <title>Add OpenStack instance meta-data info in your salt grains - Renoir Boulanger</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" property="og:image" content="https://secure.gravatar.com/avatar/cbf8c9036c204fe85e15155f9d70faec?s=400"><meta data-n-head="ssr" property="twitter:card" content="summary_large_image"><meta data-n-head="ssr" property="twitter:site" content="@renoirb"><meta data-n-head="ssr" data-hid="keywords-ansible-infrast" name="keywords" content="Ansible, Infrastructure as Code"><base href="/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="alternate" type="application/rss+xml" title="Renoir Boulanger‚Äôs Page Updates RSS Feed" href="https://renoirboulanger.com/feed.xml"><link data-n-head="ssr" rel="alternate" type="application/feed+json" title="Renoir Boulanger‚Äôs Page Updates Feed" href="https://renoirboulanger.com/feed.json"><link rel="preload" href="/_nuxt/runtime.js" as="script"><link rel="preload" href="/_nuxt/commons/app.js" as="script"><link rel="preload" href="/_nuxt/vendors/app.css" as="style"><link rel="preload" href="/_nuxt/vendors/app.js" as="script"><link rel="preload" href="/_nuxt/app.css" as="style"><link rel="preload" href="/_nuxt/app.js" as="script"><link rel="preload" href="/_nuxt/pages/blog.css" as="style"><link rel="preload" href="/_nuxt/pages/blog.js" as="script"><link rel="preload" href="/_nuxt/pages/blog/_year.js" as="script"><link rel="preload" href="/_nuxt/pages/blog/_year/_month.js" as="script"><link rel="preload" href="/_nuxt/pages/blog/_year/_month/_slug.css" as="style"><link rel="preload" href="/_nuxt/pages/blog/_year/_month/_slug.js" as="script"><link rel="stylesheet" href="/_nuxt/vendors/app.css"><link rel="stylesheet" href="/_nuxt/app.css"><link rel="stylesheet" href="/_nuxt/pages/blog.css"><link rel="stylesheet" href="/_nuxt/pages/blog/_year/_month/_slug.css"><link rel="preload" href="/_nuxt/static/1729799378/blog/2015/05/add-openstack-instance-meta-data-info-salt-grains/state.js" as="script"><link rel="preload" href="/_nuxt/static/1729799378/blog/2015/05/add-openstack-instance-meta-data-info-salt-grains/payload.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function (){"use strict";var e=window,t=document,s=t.documentElement,n=["dark","light"],a=function(e){for(var s=e+"=",n=t.cookie.split(";"),a=0;a<n.length;a++){for(var o=n[a];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(s))return o.substring(s.length,o.length)}return null}("nuxt-color-mode")||"light",o="system"===a?i():a;function r(e){var t=e+"-mode";s.classList?s.classList.add(t):s.className+=" "+t}function c(t){return e.matchMedia("(prefers-color-scheme"+t+")")}function i(){if(e.matchMedia&&"not all"!==c("").media)for(var t of n)if(c(":"+t).matches)return t;return"light"}r(o),e["__NUXT_COLOR_MODE__"]={preference:a,value:o,getColorScheme:i,addClass:r,removeClass:function(e){var t=e+"-mode";s.classList?s.classList.remove(t):s.className=s.className.replace(new RegExp(t,"g"),"")}}}();
</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="layouts--default"><!----> <nav class="app-side-bar--component fixed z-40 w-full top z-50" data-v-cf57f860 data-v-2b2f37b3><div class="zone__sandwich__top container flex items-center justify-between py-4 mx-auto" style="position:relative" data-v-cf57f860><!----> <div class="app-side-bar__identity md:px-5 flex items-center" data-v-cf57f860><button aria-label="Open Menu" class="md:hidden ml-5 mr-2" data-v-cf57f860><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" class="w-8 h-8" data-v-cf57f860><path d="M4 6h16M4 12h16M4 18h16" data-v-cf57f860></path></svg></button> <a href="/" data-wip="components/global/AppSideBar.vue" class="identity__text font-semibold nuxt-link-active" data-v-cf57f860>
        Renoir Boulanger
      </a></div> <div class="app-side-bar__nav flex items-center" data-v-cf57f860><div class="md:flex md:justify-between md:bg-transparent text-is-italicized hidden" data-v-cf57f860><a href="/blog" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded nuxt-link-active" data-v-2b2f37b3>
      Blog
    </a><a href="/projects" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded" data-v-2b2f37b3>
      Projects
    </a><a href="/resume/as-code" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded" data-v-2b2f37b3>
      Resume
    </a><a href="/hello" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded" data-v-2b2f37b3>
      About
    </a></div></div></div> <aside class="md:invisible app-side-bar__aside fixed top-0 left-0 visible w-64 h-full overflow-auto transition-all duration-500 ease-in-out transform -translate-x-full" data-v-cf57f860><div class="app-side-bar__identity flex items-center w-full h-16 p-4 border-b" data-v-cf57f860><a href="/" class="identity__text nuxt-link-active" data-v-cf57f860>Renoir Boulanger</a></div> <div data-v-cf57f860><a href="/blog" class="hover:bg-teal-500 hover:text-white flex items-center p-4 nuxt-link-active" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          Blog
        </span></a><a href="/projects" class="hover:bg-teal-500 hover:text-white flex items-center p-4" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          Projects
        </span></a><a href="/resume/as-code" class="hover:bg-teal-500 hover:text-white flex items-center p-4" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          Resume
        </span></a><a href="/hello" class="hover:bg-teal-500 hover:text-white flex items-center p-4" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          About
        </span></a></div></aside></nav> <div class="fixed inset-0 z-40 transition-opacity" style="display:none"><div class="absolute inset-0 bg-black opacity-75"></div></div> <main class="zone__sandwich__meat middle container z-40 mx-auto"><div data-wip="layout/default.vue" class="md:m-10 grid grid-cols-1 m-5"><section data-wip="pages/blog.vue" class="pages__blog--parent"><div class="pages-blog--parent--top justify-items-stretch sm:grid-cols-2 sm:grid-flow-row md:grid-flow-col-dense grid grid-cols-1 gap-4"><nav class="breadcrumb" data-v-ede238bc><ol class="list-none p-0 inline-flex" data-v-ede238bc><li class="flex items-center" data-v-ede238bc><a href="/blog" class="nuxt-link-active" data-v-ede238bc>blog</a></li><li class="flex items-center" data-v-ede238bc><a href="/blog/2015" class="nuxt-link-active" data-v-ede238bc>2015</a></li><li class="flex items-center" data-v-ede238bc><a href="/blog/2015/05" class="nuxt-link-active" data-v-ede238bc>05</a></li></ol></nav></div> <!----> <div class="pages-blog--parent--bottom"><div q=""><!----> <div><div class="pages__blog__year__month--parent"><div class="pages__blog__year__month__slug--item" data-v-79a168f2><div data-v-79a168f2><rb-notice-box variant="warn" role="alert" class="disposition-parent app-alert-box my-4" data-v-79a168f2 data-v-79a168f2><!----> <!----> <div class="nuxt-content" data-v-79a168f2><p data-v-79a168f2>It is possible the code shown here no longer works.
This was written at the time before VMWare aquired SaltStack and maybe
code shown uses parts of Salt Stack that no longer exists.</p></div></rb-notice-box></div> <div class="document document--item z-30" data-v-79a168f2><div data-wip="pages/blog/_year/_month/_slug.vue" class="title page-title lg:pr-64 mb-4 font-serif text-2xl italic" data-v-79a168f2><h1 data-v-79a168f2>Add OpenStack instance meta-data info in your salt grains</h1></div> <div class="mt-0 mb-5 font-serif text-sm italic" data-v-79a168f2><time datetime="2015-05-22" data-v-79a168f2>
        Friday, May 22, 2015
      </time> <a href="https://renoirboulanger.com/blog/2015/05/add-openstack-instance-meta-data-info-salt-grains/" lang="en" target="_blank" title="Canonical link, the URL it is meant to replace" class="canonical-link hidden" data-v-79a168f2>
        Canonical
      </a></div> <div class="taxonomy mt-0 mb-5 taxonomy-hoverizable" data-v-79a168f2><strong id="tags__226" class="taxonomy-label">
    Tags
  </strong> <ul aria-labelled-by="tags__226" class="taxonomy-items"><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/linux" class="no-underline">linux</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/operations" class="no-underline">operations</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/salt-stack" class="no-underline">salt-stack</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/cloud-computing" class="no-underline">cloud-computing</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/open-source" class="no-underline">open-source</nuxtlink></li> <li class="category px-2 py-1 mb-3 mr-3 is-hoverizable"><a href="/blog/category/snippet" class="no-underline">üìÅ snippet</a></li></ul></div> <div class="body mt-10" data-v-79a168f2><figure class="document-cover md:float-right lg:w-1/3 md:pl-5 sm:w-1/2 relative z-30 float-none pb-5 pl-0 mx-auto mt-1 app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/webplatform-openstack-cluster-2014-10-06.png" alt="A terminal window showing Open Stack nova client output" data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/webplatform-openstack-cluster-2014-10-06.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> <div class="nuxt-content" data-v-33ff8cb7 data-v-79a168f2><p data-v-33ff8cb7 data-v-79a168f2>Open Stack NOVA client is leveraging an internal <abbr lang="en" title="Hyper Text Transfer Protocol" data-v-33ff8cb7 data-v-79a168f2>HTTP</abbr> API to display data we can
consume from the CLI.
The present article shows how to add data from OpenStack into Salt Stack.</p></div></figcaption></figure> <div class="nuxt-content" data-v-79a168f2 data-v-79a168f2><p data-v-79a168f2 data-v-79a168f2>During a work session on my salt-states for WebPlatform.org I wanted to shape be
able to query the OpenStack cluster meta-data so that I can adjust more
efficiently my salt configuration.</p>
<p data-v-79a168f2 data-v-79a168f2>What are grains? Grains are structured data that describes what a minion has
such as which version of GNU/Linux its running, what are the network adapters,
etc.</p>
<p data-v-79a168f2 data-v-79a168f2>The following is a Python script that adds data in Salt Stack' internal database
called grains.</p>
<p data-v-79a168f2 data-v-79a168f2>I have to confess that I didn't write the script but adapted it to work within
an OpenStack cluster. More precisely on DreamHost's DreamCompute cluster. The
original script came from <a href="https://github.com/saltstack/salt-contrib" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>saltstack/salt-contrib</a> and the original file was
<a href="https://github.com/saltstack/salt-contrib/blob/master/grains/ec2_info.py" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>ec2_info.py</a> to read data from EC2.</p>
<p data-v-79a168f2 data-v-79a168f2>The <a href="https://github.com/saltstack/salt-contrib/blob/master/grains/ec2_info.py" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>original script</a> wasn't getting any data in the cluster. Most likely due
to API changes and that EC2 API exposes dynamic meta-data that the
DreamCompute/OpenStack cluster don't.</p>
<rb-notice-box variant="info" class="my-5" data-v-79a168f2 data-v-79a168f2>
<strong slot="header" data-v-79a168f2 data-v-79a168f2>Script source</strong>
<p data-v-79a168f2 data-v-79a168f2>The article‚Äôs source script is available on GitHub as a Python script we can
insert into SaltStack as a grain</p>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2><a href="https://github.com/webplatform/salt-states/blob/master/_grains/dreamcompute.py" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>github.com/webplatform/salt-states</a></li>
</ul>
</rb-notice-box>
<p data-v-79a168f2 data-v-79a168f2>In the end, I edited the file to make it work on DreamCompute and also truncated
some data that the grains subsystem already has.</p>
<p data-v-79a168f2 data-v-79a168f2>My original objective was to get a list of <code data-v-79a168f2 data-v-79a168f2>security-groups</code> the VM was
assigned. Unfortunately the API doesn't give that information yet. Hopefully
I'll find a way to get that information some day.</p>
<h2 id="get-openstack-instance-detail-using-salt" data-v-79a168f2 data-v-79a168f2><a href="#get-openstack-instance-detail-using-salt" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Get OpenStack instance detail using Salt</h2>
<p data-v-79a168f2 data-v-79a168f2>Locally</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>salt-call grains.get dreamcompute:uuid
</code></pre></div>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-yaml" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token key atrule" data-v-79a168f2 data-v-79a168f2>local</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
    10a4f390<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>7c55<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>4dd3<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>0000<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>a00000000000
</code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>Or for another machine</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>salt app1 grains.get dreamcompute:uuid
</code></pre></div>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-yaml" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token key atrule" data-v-79a168f2 data-v-79a168f2>app1</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
    510f5f24<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>217b<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>4fd2<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>0000<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>f00000000000
</code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>What size did we create a particular VM?</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>salt app1 grains.get dreamcompute:instance_type
</code></pre></div>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-yaml" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token key atrule" data-v-79a168f2 data-v-79a168f2>app1</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
    lightspeed
</code></pre></div>
<h2 id="what-data-you-can-get" data-v-79a168f2 data-v-79a168f2><a href="#what-data-you-can-get" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>What data you can get</h2>
<p data-v-79a168f2 data-v-79a168f2>Here is a sample of the grain data that will be added to every salt minion you
manage.</p>
<p data-v-79a168f2 data-v-79a168f2>You might notice that some data will be repeated such as the 'hostname', but the
rest can be very useful if you want to use the data within your configuration
manag</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-yaml" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token key atrule" data-v-79a168f2 data-v-79a168f2>dreamcompute</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
    <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>availability_zone</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        iad<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span><span class="token number" data-v-79a168f2 data-v-79a168f2>1</span>
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>block_device_mapping</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>ami</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            vda
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>ebs0</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            /dev/vdb
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>ebs1</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            vda
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>root</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            /dev/vda
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>hostname</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        salt.novalocal
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>instance_action</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        none
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>instance_id</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        i<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span><span class="token number" data-v-79a168f2 data-v-79a168f2>00000000</span>
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>instance_type</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        lightspeed
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>launch_index</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        <span class="token number" data-v-79a168f2 data-v-79a168f2>0</span>
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>local_ipv4</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        10.10.10.11
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>name</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        salt
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>network_config</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>content_path</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            /content/0000
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>name</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            network_config
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>placement</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>availability_zone</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            iad<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span><span class="token number" data-v-79a168f2 data-v-79a168f2>1</span>
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>public_ipv4</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        203.0.113.11
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>public_keys</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>---</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>
        <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>someuser</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
            ssh<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>rsa <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>...</span>an rsa public key<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>...</span> someuser<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>comment@example.org
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>ramdisk_id</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        None
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>reservation_id</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        r<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span><span class="token number" data-v-79a168f2 data-v-79a168f2>33333333</span>
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>security-groups</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        None
    <span class="token key atrule" data-v-79a168f2 data-v-79a168f2>uuid</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>:</span>
        10a4f390<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>7c55<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>4dd3<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>0000<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>-</span>a00000000000
</code></pre></div>
<h2 id="what-does-the-script-do" data-v-79a168f2 data-v-79a168f2><a href="#what-does-the-script-do" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>What does the script do?</h2>
<p data-v-79a168f2 data-v-79a168f2>The script basically scrapes OpenStack meta-data service and serializes into
saltstack grains system the data it gets.</p>
<p data-v-79a168f2 data-v-79a168f2><a href="http://docs.openstack.org/admin-guide-cloud/content/section_metadata-service.html" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>OpenStack's meta-data service</a> is similar to what you'd get from AWS, but
doesn't expose exactly the same data. This is why I had to adapt the original
script.</p>
<p data-v-79a168f2 data-v-79a168f2>To get data from an instance you simply (really!) need to make an HTTP call to
an <a href="http://docs.openstack.org/admin-guide-cloud/content/section_metadata-service.html" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>internal IP address that OpenStack nova</a> answers. (that‚Äôs what the IPv4
address starting by <code data-v-79a168f2 data-v-79a168f2>169.</code> is)</p>
<p data-v-79a168f2 data-v-79a168f2>For example, from an AWS/OpenStack VM, you can know the instance hostname by
doing</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>curl</span> http://169.254.169.254/latest/meta-data/hostname

salt.novalocal
</code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>To know what the script calls, <a href="https://github.com/webplatform/salt-states/commit/821ca803#diff-6eea2056af3e939361a559b84665c1d97fc9e062f7b7f79910567fc688881056R33" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>you can add a line at <code data-v-79a168f2 data-v-79a168f2>_call_aws(url)</code>
method</a> (<a href="https://github.com/webplatform/salt-states/commit/821ca803#diff-6eea2056af3e939361a559b84665c1d97fc9e062f7b7f79910567fc688881056R32-R34" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>lines 32-34</a>), like so;</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-diff" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>diff --git a/_grains/dreamcompute.py b/_grains/dreamcompute.py
index 682235d..c3af659 100644
<span class="token coord" data-v-79a168f2 data-v-79a168f2>--- a/_grains/dreamcompute.py</span>
<span class="token coord" data-v-79a168f2 data-v-79a168f2>+++ b/_grains/dreamcompute.py</span>
@@ -25,6 +25,7 @@ def _call_aws(url):

<span class="token unchanged" data-v-79a168f2 data-v-79a168f2><span class="token prefix unchanged" data-v-79a168f2 data-v-79a168f2> </span><span class="token line" data-v-79a168f2 data-v-79a168f2>    """
</span><span class="token prefix unchanged" data-v-79a168f2 data-v-79a168f2> </span><span class="token line" data-v-79a168f2 data-v-79a168f2>    conn = httplib.HTTPConnection("169.254.169.254", 80, timeout=1)
</span></span><span class="token inserted-sign inserted" data-v-79a168f2 data-v-79a168f2><span class="token prefix inserted" data-v-79a168f2 data-v-79a168f2>+</span><span class="token line" data-v-79a168f2 data-v-79a168f2>    LOG.info('API call to ' + url )
</span></span><span class="token unchanged" data-v-79a168f2 data-v-79a168f2><span class="token prefix unchanged" data-v-79a168f2 data-v-79a168f2> </span><span class="token line" data-v-79a168f2 data-v-79a168f2>    conn.request('GET', url)
</span><span class="token prefix unchanged" data-v-79a168f2 data-v-79a168f2> </span><span class="token line" data-v-79a168f2 data-v-79a168f2>    return conn.getresponse()
</span></span></code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>When you <code data-v-79a168f2 data-v-79a168f2>saltutil.sync_all</code> (i.e. refresh grains and other data), the log will
tell you which endpoints it queried.</p>
<p data-v-79a168f2 data-v-79a168f2>In my case they were:</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-shellsession" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token output" data-v-79a168f2 data-v-79a168f2>[INFO    ] API call to /openstack/2012-08-10/meta_data.json
[INFO    ] API call to /latest/meta-data/
[INFO    ] API call to /latest/meta-data/block-device-mapping/
[INFO    ] API call to /latest/meta-data/block-device-mapping/ami
[INFO    ] API call to /latest/meta-data/block-device-mapping/ebs0
[INFO    ] API call to /latest/meta-data/block-device-mapping/ebs1
[INFO    ] API call to /latest/meta-data/block-device-mapping/root
[INFO    ] API call to /latest/meta-data/hostname
[INFO    ] API call to /latest/meta-data/instance-action
[INFO    ] API call to /latest/meta-data/instance-id
[INFO    ] API call to /latest/meta-data/instance-type
[INFO    ] API call to /latest/meta-data/local-ipv4
[INFO    ] API call to /latest/meta-data/placement/
[INFO    ] API call to /latest/meta-data/placement/availability-zone
[INFO    ] API call to /latest/meta-data/public-ipv4
[INFO    ] API call to /latest/meta-data/ramdisk-id
[INFO    ] API call to /latest/meta-data/reservation-id
[INFO    ] API call to /latest/meta-data/security-groups
[INFO    ] API call to /openstack/2012-08-10/meta_data.json
[INFO    ] API call to /latest/meta-data/
[INFO    ] API call to /latest/meta-data/block-device-mapping/
[INFO    ] API call to /latest/meta-data/block-device-mapping/ami
[INFO    ] API call to /latest/meta-data/block-device-mapping/ebs0
[INFO    ] API call to /latest/meta-data/block-device-mapping/ebs1
[INFO    ] API call to /latest/meta-data/block-device-mapping/root
[INFO    ] API call to /latest/meta-data/hostname
[INFO    ] API call to /latest/meta-data/instance-action
[INFO    ] API call to /latest/meta-data/instance-id
[INFO    ] API call to /latest/meta-data/instance-type
[INFO    ] API call to /latest/meta-data/local-ipv4
[INFO    ] API call to /latest/meta-data/placement/
[INFO    ] API call to /latest/meta-data/placement/availability-zone
[INFO    ] API call to /latest/meta-data/public-ipv4
[INFO    ] API call to /latest/meta-data/ramdisk-id
[INFO    ] API call to /latest/meta-data/reservation-id
[INFO    ] API call to /latest/meta-data/security-groups
</span></code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>Its quite heavy.</p>
<p data-v-79a168f2 data-v-79a168f2>Hopefully the script respects HTTP headers and don't bypass <code data-v-79a168f2 data-v-79a168f2>304 Not Modified</code>
responses. Otherwise it'll add load to nova. Maybe I should check that
(note-to-self).</p>
<h2 id="install" data-v-79a168f2 data-v-79a168f2><a href="#install" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Install</h2>
<p data-v-79a168f2 data-v-79a168f2>You can add this feature by adding a file in your salt states repository in the
<code data-v-79a168f2 data-v-79a168f2>_grains/</code> folder. The file can have any name ending by <code data-v-79a168f2 data-v-79a168f2>.py</code>.</p>
<p data-v-79a168f2 data-v-79a168f2>You can grab the grain python code <a href="https://gist.github.com/WebPlatformDocs/6b26b67321fe15870aa0" rel="nofollow noopener noreferrer" target="_blank" title="Gist where you can add openstack meta-data in your grains" data-v-79a168f2 data-v-79a168f2>in this gist</a>.</p>


</div> <div class="clearfix" data-v-79a168f2></div></div> <div class="text-md grid grid-cols-2 my-10" style="display:none" data-v-4d2003f9 data-v-79a168f2><div class="text-left" data-v-4d2003f9><a href="/blog/2015/05/converting-dynamic-site-static-copy" lang="en-CA" class="hover:underline item-prev" data-v-4d2003f9>
      Converting a dynamic site into static HTML documents
    </a></div> <div class="text-right" data-v-4d2003f9><a href="/blog/2015/07/migrating-webplatform-org-mediawiki-into-git-history-and-into-markdown-files" lang="en-CA" class="hover:underline item-next" data-v-4d2003f9>
      Migrating WebPlatform.org MediaWiki into Git as Markdown files
    </a></div></div></div></div></div></div></div></div></section></div></main> <div timezone="America/New_York" class="app-footer--component disposition-parent w-full bottom" data-v-7116e49f><footer class="zone__sandwich__bottom container flex items-center justify-between p-10 mx-auto" style="position:relative" data-v-7116e49f><dl class="contact items-item disposition-item" data-v-7116e49f><dt class="mb-4 font-serif text-2xl" data-v-7116e49f><a href="/contact" class="underline" data-v-7116e49f>Contact</a></dt> <dd data-v-7116e49f>Fascinated By The Open Web Platform</dd> <dd aria-errormessage="why-fou-de-la-pouitte" data-v-7116e49f>
        Send your remarks using
        <em data-fou-de-la-pouitte title="Please type this manually" class="underline" data-v-7116e49f><span id="why-fou-de-la-pouitte" class="sr-only" data-v-7116e49f>
            An email address written using CSS, apologies for obfuscating
            this.
          </span></em></dd> <dd class="underline sr-only" data-v-7116e49f><a rel="me" href="https://mastodon.social/@renoirb" data-v-7116e49f>
          @renoirb@mastodon.social
        </a></dd> <dd class="underline sr-only" data-v-7116e49f><a rel="me" href="https://w3c.social/@renoirb" data-v-7116e49f>
          @renoirb@w3c.social
        </a></dd> <dd class="font-mono" data-v-7116e49f>v4.0.0-dev</dd> <span class="inline-flex" data-v-7116e49f><button aria-label="Color Mode" class="hover:text-primary-500 focus:outline-none transition duration-150 ease-in-out rounded-md"><!----> <!----></button></span></dl> <div class="items-item disposition-item" data-v-7116e49f><dl lang="fr-CA" class="see-also" data-v-7116e49f><dt data-v-7116e49f>Voir aussi‚Ä¶</dt> <dd data-v-7116e49f><a href="/ligne-editoriale" data-v-7116e49f> Ligne¬†√©ditoriale </a></dd> <dd data-v-7116e49f><a href="/projects" data-v-7116e49f> Projets </a></dd> <dd data-v-7116e49f><a href="/glossary" lang="en" data-v-7116e49f> Glossary </a></dd> <dd data-v-7116e49f><a href="/code-review" lang="en" data-v-7116e49f>
            Code-Review¬†notes
          </a></dd></dl></div></footer></div></div></div></div><script defer src="/_nuxt/static/1729799378/blog/2015/05/add-openstack-instance-meta-data-info-salt-grains/state.js"></script><script src="/_nuxt/runtime.js" defer></script><script src="/_nuxt/pages/blog.js" defer></script><script src="/_nuxt/pages/blog/_year.js" defer></script><script src="/_nuxt/pages/blog/_year/_month.js" defer></script><script src="/_nuxt/pages/blog/_year/_month/_slug.js" defer></script><script src="/_nuxt/commons/app.js" defer></script><script src="/_nuxt/vendors/app.js" defer></script><script src="/_nuxt/app.js" defer></script><script data-n-head="ssr" type="module" vmid="load-esm-modules-separately-please" data-body="true" defer>
/**
 * #WIP-Mingle-CustomElements-From-ESM-Modules: Added on 2024-09-18 during migration.
 */
import { registerCustomElement } from 'https://renoirb.com/esm-modules/element-utils.mjs'
import NoticeBoxElement from 'https://renoirb.com/esm-modules/notice-box-element.mjs'
try {
  registerCustomElement(window, 'rb-notice-box', NoticeBoxElement)
} catch (e) {
  // #XXX FIX ME because this gets loaded
  console.log('Already loaded', e)
}
        </script>
  </body>
</html>
