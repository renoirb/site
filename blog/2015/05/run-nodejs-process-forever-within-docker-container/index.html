<!doctype html>
<html data-n-head-ssr class="layout--default zone__sandwich light-mode" lang="en-CA" data-n-head="%7B%22class%22:%7B%22ssr%22:%5B%22layout--default%22,%22zone__sandwich%22,%22light-mode%22%5D%7D,%22lang%22:%7B%22ssr%22:%22en-CA%22%7D%7D">
  <head>
    <title>Run a NodeJS process through forever from within a Docker container - Renoir Boulanger</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width,initial-scale=1"><meta data-n-head="ssr" data-hid="description" name="description" content=""><meta data-n-head="ssr" property="og:image" content="https://secure.gravatar.com/avatar/cbf8c9036c204fe85e15155f9d70faec?s=400"><meta data-n-head="ssr" property="twitter:card" content="summary_large_image"><meta data-n-head="ssr" property="twitter:site" content="@renoirb"><base href="/"><link data-n-head="ssr" rel="icon" type="image/x-icon" href="/favicon.ico"><link data-n-head="ssr" rel="alternate" type="application/rss+xml" title="Renoir Boulanger‚Äôs Page Updates RSS Feed" href="https://renoirboulanger.com/feed.xml"><link data-n-head="ssr" rel="alternate" type="application/feed+json" title="Renoir Boulanger‚Äôs Page Updates Feed" href="https://renoirboulanger.com/feed.json"><link rel="preload" href="/_nuxt/runtime.js" as="script"><link rel="preload" href="/_nuxt/commons/app.js" as="script"><link rel="preload" href="/_nuxt/vendors/app.css" as="style"><link rel="preload" href="/_nuxt/vendors/app.js" as="script"><link rel="preload" href="/_nuxt/app.css" as="style"><link rel="preload" href="/_nuxt/app.js" as="script"><link rel="preload" href="/_nuxt/pages/blog.css" as="style"><link rel="preload" href="/_nuxt/pages/blog.js" as="script"><link rel="preload" href="/_nuxt/pages/blog/_year.js" as="script"><link rel="preload" href="/_nuxt/pages/blog/_year/_month.js" as="script"><link rel="preload" href="/_nuxt/pages/blog/_year/_month/_slug.css" as="style"><link rel="preload" href="/_nuxt/pages/blog/_year/_month/_slug.js" as="script"><link rel="stylesheet" href="/_nuxt/vendors/app.css"><link rel="stylesheet" href="/_nuxt/app.css"><link rel="stylesheet" href="/_nuxt/pages/blog.css"><link rel="stylesheet" href="/_nuxt/pages/blog/_year/_month/_slug.css"><link rel="preload" href="/_nuxt/static/1729799378/blog/2015/05/run-nodejs-process-forever-within-docker-container/state.js" as="script"><link rel="preload" href="/_nuxt/static/1729799378/blog/2015/05/run-nodejs-process-forever-within-docker-container/payload.js" as="script">
  </head>
  <body>
    <script data-n-head="ssr" data-hid="nuxt-color-mode-script" data-pbody="true">!function (){"use strict";var e=window,t=document,s=t.documentElement,n=["dark","light"],a=function(e){for(var s=e+"=",n=t.cookie.split(";"),a=0;a<n.length;a++){for(var o=n[a];" "===o.charAt(0);)o=o.substring(1,o.length);if(0===o.indexOf(s))return o.substring(s.length,o.length)}return null}("nuxt-color-mode")||"light",o="system"===a?i():a;function r(e){var t=e+"-mode";s.classList?s.classList.add(t):s.className+=" "+t}function c(t){return e.matchMedia("(prefers-color-scheme"+t+")")}function i(){if(e.matchMedia&&"not all"!==c("").media)for(var t of n)if(c(":"+t).matches)return t;return"light"}r(o),e["__NUXT_COLOR_MODE__"]={preference:a,value:o,getColorScheme:i,addClass:r,removeClass:function(e){var t=e+"-mode";s.classList?s.classList.remove(t):s.className=s.className.replace(new RegExp(t,"g"),"")}}}();
</script><div data-server-rendered="true" id="__nuxt"><!----><div id="__layout"><div class="layouts--default"><!----> <nav class="app-side-bar--component fixed z-40 w-full top z-50" data-v-cf57f860 data-v-2b2f37b3><div class="zone__sandwich__top container flex items-center justify-between py-4 mx-auto" style="position:relative" data-v-cf57f860><!----> <div class="app-side-bar__identity md:px-5 flex items-center" data-v-cf57f860><button aria-label="Open Menu" class="md:hidden ml-5 mr-2" data-v-cf57f860><svg fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" class="w-8 h-8" data-v-cf57f860><path d="M4 6h16M4 12h16M4 18h16" data-v-cf57f860></path></svg></button> <a href="/" data-wip="components/global/AppSideBar.vue" class="identity__text font-semibold nuxt-link-active" data-v-cf57f860>
        Renoir Boulanger
      </a></div> <div class="app-side-bar__nav flex items-center" data-v-cf57f860><div class="md:flex md:justify-between md:bg-transparent text-is-italicized hidden" data-v-cf57f860><a href="/blog" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded nuxt-link-active" data-v-2b2f37b3>
      Blog
    </a><a href="/projects" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded" data-v-2b2f37b3>
      Projects
    </a><a href="/resume/as-code" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded" data-v-2b2f37b3>
      Resume
    </a><a href="/hello" class="hover:opacity-100 opacity-80 hover:underline flex items-center p-3 px-4 py-2 mr-2 font-medium text-center rounded" data-v-2b2f37b3>
      About
    </a></div></div></div> <aside class="md:invisible app-side-bar__aside fixed top-0 left-0 visible w-64 h-full overflow-auto transition-all duration-500 ease-in-out transform -translate-x-full" data-v-cf57f860><div class="app-side-bar__identity flex items-center w-full h-16 p-4 border-b" data-v-cf57f860><a href="/" class="identity__text nuxt-link-active" data-v-cf57f860>Renoir Boulanger</a></div> <div data-v-cf57f860><a href="/blog" class="hover:bg-teal-500 hover:text-white flex items-center p-4 nuxt-link-active" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          Blog
        </span></a><a href="/projects" class="hover:bg-teal-500 hover:text-white flex items-center p-4" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          Projects
        </span></a><a href="/resume/as-code" class="hover:bg-teal-500 hover:text-white flex items-center p-4" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          Resume
        </span></a><a href="/hello" class="hover:bg-teal-500 hover:text-white flex items-center p-4" data-v-cf57f860><span class="mr-2" data-v-cf57f860>
          About
        </span></a></div></aside></nav> <div class="fixed inset-0 z-40 transition-opacity" style="display:none"><div class="absolute inset-0 bg-black opacity-75"></div></div> <main class="zone__sandwich__meat middle container z-40 mx-auto"><div data-wip="layout/default.vue" class="md:m-10 grid grid-cols-1 m-5"><section data-wip="pages/blog.vue" class="pages__blog--parent"><div class="pages-blog--parent--top justify-items-stretch sm:grid-cols-2 sm:grid-flow-row md:grid-flow-col-dense grid grid-cols-1 gap-4"><nav class="breadcrumb" data-v-ede238bc><ol class="list-none p-0 inline-flex" data-v-ede238bc><li class="flex items-center" data-v-ede238bc><a href="/blog" class="nuxt-link-active" data-v-ede238bc>blog</a></li><li class="flex items-center" data-v-ede238bc><a href="/blog/2015" class="nuxt-link-active" data-v-ede238bc>2015</a></li><li class="flex items-center" data-v-ede238bc><a href="/blog/2015/05" class="nuxt-link-active" data-v-ede238bc>05</a></li></ol></nav></div> <!----> <div class="pages-blog--parent--bottom"><div q=""><!----> <div><div class="pages__blog__year__month--parent"><div class="pages__blog__year__month__slug--item" data-v-79a168f2><div data-v-79a168f2><rb-notice-box variant="warn" role="alert" class="disposition-parent app-alert-box my-4" data-v-79a168f2 data-v-79a168f2><!----> <!----> <div class="nuxt-content" data-v-79a168f2></div></rb-notice-box></div> <div class="document document--item z-30" data-v-79a168f2><div data-wip="pages/blog/_year/_month/_slug.vue" class="title page-title lg:pr-64 mb-4 font-serif text-2xl italic" data-v-79a168f2><h1 data-v-79a168f2>Run a NodeJS process through forever from within a Docker container</h1></div> <div class="mt-0 mb-5 font-serif text-sm italic" data-v-79a168f2><time datetime="2015-05-12" data-v-79a168f2>
        Tuesday, May 12, 2015
      </time> <a href="https://renoirboulanger.com/blog/2015/05/run-nodejs-process-forever-within-docker-container/" lang="en" target="_blank" title="Canonical link, the URL it is meant to replace" class="canonical-link hidden" data-v-79a168f2>
        Canonical
      </a></div> <div class="taxonomy mt-0 mb-5 taxonomy-hoverizable" data-v-79a168f2><strong id="tags__228" class="taxonomy-label">
    Tags
  </strong> <ul aria-labelled-by="tags__228" class="taxonomy-items"><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/linux" class="no-underline">linux</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/docker" class="no-underline">docker</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/open-source" class="no-underline">open-source</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/operations" class="no-underline">operations</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/procedure" class="no-underline">procedure</nuxtlink></li><li class="px-2 py-1 mb-3 mr-3 is-hoverizable"><nuxtlink to="/blog/tag/webplatform" class="no-underline">webplatform</nuxtlink></li> <li class="category px-2 py-1 mb-3 mr-3 is-hoverizable"><a href="/blog/category/projects" class="no-underline">üìÅ projects</a></li></ul></div> <div class="body mt-10" data-v-79a168f2><figure class="document-cover md:float-right lg:w-1/3 md:pl-5 sm:w-1/2 relative z-30 float-none pb-5 pl-0 mx-auto mt-1 app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-spec-rangefinder.png" alt="Screen capture of the RangeFinder API using Publican" data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-spec-rangefinder.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> <div class="nuxt-content" data-v-33ff8cb7 data-v-79a168f2><p data-v-33ff8cb7 data-v-79a168f2>Specification Document for RangeFinder API</p></div></figcaption></figure> <div class="nuxt-content" data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>One of the components that I worked on <a href="/blog/tag/webplatform-docs" data-v-79a168f2>during my time on the WebPlatform
project</a>, <a href="https://github.com/webspecs/publican" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Publican</a>, that I had to manage has many moving parts. The
end product of that component is basically static HTML documents that ends up on
<a href="https://specs.webplatform.org/" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>specs.webplatform.org</a>.</p>
<p data-v-79a168f2 data-v-79a168f2>Since we need to have many packages installed in very specific version, and
automating the installation wouldn't bring any more benefit than being
self-contained, I thought it would be best to go through the steps of converting
it into a Docker container.</p>
<p data-v-79a168f2 data-v-79a168f2>The following is a procedure I wrote to teach <a href="https://www.w3.org/staff/alumni/#robin-berjon" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>my colleague</a>, <a href="https://berjon.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Robin
Berjon</a>, how to run his system called <a href="https://github.com/webspecs/publican" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Publican</a> from within a Docker
container. Publican is basically a GitHub hook listener that generates specs
written to be parsed by <a href="https://github.com/w3c/respec" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>ReSpec</a> or <a href="https://github.com/tabatkins/bikeshed" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Bikeshed</a></p>
<h2 id="run-publican-inside-docker" data-v-79a168f2 data-v-79a168f2><a href="#run-publican-inside-docker" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Run <em data-v-79a168f2 data-v-79a168f2>publican</em> inside Docker</h2>
<p data-v-79a168f2 data-v-79a168f2>What this'll do is basically build a VM that'll run a Docker container. The
container will write in files outside of it.</p>
<p data-v-79a168f2 data-v-79a168f2>You'll quickly notice that the paths will look the same, its confusing, sorry
about that. Fortunately for us, the paths in the procedure are the ones that
will be mounted through Docker Volume (the <code data-v-79a168f2 data-v-79a168f2>-v</code> option when you call <code data-v-79a168f2 data-v-79a168f2>docker</code>)
and will, in the end, be the same files.</p>
<p data-v-79a168f2 data-v-79a168f2>Once you have a Docker container running on a VM, it'll replicate how a
production VM will run the tasks. Since we know where the container will write
files, we'll have our frontend servers to forward requests to publican, and
serve files it generated.</p>
<p data-v-79a168f2 data-v-79a168f2>Doing all this removes the need to do any rsync. NGINX within the VM that'll run
Docker will take care of serving static files, and frontend server will expose
it to the public.</p>
<h3 id="steps" data-v-79a168f2 data-v-79a168f2><a href="#steps" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Steps</h3>
<ol data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>Have <a href="https://www.vagrantup.com/" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Vagrant</a> and <a href="https://www.virtualbox.org/" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>VirtualBox</a> installed</li>
<li data-v-79a168f2 data-v-79a168f2>Follow what's in <a href="https://github.com/renoirb/salt-basesystem" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>renoirb/salt-basesystem README.md</a></li>
</ol>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Make sure you follow <a href="https://github.com/renoirb/salt-basesystem#vagrant-sandbox-utilities" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Vagrant Sandbox utilities</a> part</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> vagrant <span class="token function" data-v-79a168f2 data-v-79a168f2>ssh</span>
 <span class="token function" data-v-79a168f2 data-v-79a168f2>sudo</span> salt-call state.highstate
 <span class="token function" data-v-79a168f2 data-v-79a168f2>sudo</span> salt-call state.sls vagrantsandbox.docker
 <span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>exit</span>
</code></pre></div>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Reboot the VM by doing <code data-v-79a168f2 data-v-79a168f2>vagrant reload</code></p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> vagrant reload
</code></pre></div>
</li>
</ul>
<ol data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2><strong data-v-79a168f2 data-v-79a168f2>No need</strong> to follow what's in <a href="https://github.com/webplatform/publican/blob/task-based-docker/DOCKER.md" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>webplatform/publican DOCKER.md file</a>.
Those are notes to show how to build a container. For this time, we'll <a href="https://registry.hub.docker.com/u/webspecs/publican/" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>use a
container I already built and pushed on <strong data-v-79a168f2 data-v-79a168f2>Docker hub</strong></a>!</p>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Setup what's required to run the container</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> vagrant <span class="token function" data-v-79a168f2 data-v-79a168f2>ssh</span>
</code></pre></div>
</li>
</ol>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Prepare the folders;</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> <span class="token function" data-v-79a168f2 data-v-79a168f2>sudo</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-s</span>
 <span class="token function" data-v-79a168f2 data-v-79a168f2>su</span> webapps
 <span class="token function" data-v-79a168f2 data-v-79a168f2>id</span>
</code></pre></div>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>You should see</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-text" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> uid=990(webapps) gid=990(webapps) groups=990(webapps),33(www-data),998(docker)
</code></pre></div>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Prepare the folders</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> <span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>cd</span> /srv/webapps <span class="token function" data-v-79a168f2 data-v-79a168f2>mkdir</span> publican/data <span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>cd</span> publican
</code></pre></div>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>If all went well so far; you should be able to do <code data-v-79a168f2 data-v-79a168f2>docker ps</code> as the
<code data-v-79a168f2 data-v-79a168f2>webapps</code> user. Otherwise reboot and/or run <code data-v-79a168f2 data-v-79a168f2>salt-call</code> with both
<code data-v-79a168f2 data-v-79a168f2>state.highstate</code> <code data-v-79a168f2 data-v-79a168f2>state.sls vagrantsandbox.docker</code> states. There should be
nothing left to do.</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>docker</span> <span class="token function" data-v-79a168f2 data-v-79a168f2>ps</span>

CONTAINER ID IMAGE COMMAND CREATED
<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>..</span>.
</code></pre></div>
</li>
</ul>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Pull the publican Docker image I built (it'll take about 10 minutes)</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> <span class="token function" data-v-79a168f2 data-v-79a168f2>docker</span> pull webspecs/publican:wip
</code></pre></div>
</li>
</ul>
<ol data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>Copy the other files in this Gist in your local coputer where you cloned the
<strong data-v-79a168f2 data-v-79a168f2>salt-basesystem</strong> repository. From that folder you can move them inside the
Vagrant VM where you need.</li>
</ol>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Copy publican config</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> <span class="token function" data-v-79a168f2 data-v-79a168f2>cp</span> /vagrant/config.json data/
</code></pre></div>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2><del data-v-79a168f2 data-v-79a168f2>Download Bikeshed stuff that i didn't figure out yet what's important to
keep, extract it in <code data-v-79a168f2 data-v-79a168f2>/srv/webapps/publican/spec-data/</code></del>.</p>
</li>
</ul>
<rb-notice-box class="my-5" variant="info" data-v-79a168f2 data-v-79a168f2>
<strong slot="header" data-v-79a168f2 data-v-79a168f2>Archive mentioned no longer exists</strong>
The archive used in the initial procedure no longer exists, it was a series of W3C specification Git repository working copies that Publican was expecting.
</rb-notice-box>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>You can open up another terminal session and connect to the Vagrant VM
<code data-v-79a168f2 data-v-79a168f2>vagrant ssh</code> (e.g. if you don't use <code data-v-79a168f2 data-v-79a168f2>tmux</code> or <code data-v-79a168f2 data-v-79a168f2>screen</code>)</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>mkdir</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-p</span> spec-data/readonly/
<span class="token function" data-v-79a168f2 data-v-79a168f2>mkdir</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-p</span> data/<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>{</span>gits,logs,publish,queue,temp<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>}</span>
</code></pre></div>
</li>
</ul>
<ol data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Run the container</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>docker</span> run <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-it</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>--rm</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-v</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"<span class="token variable" data-v-79a168f2 data-v-79a168f2><span class="token variable" data-v-79a168f2 data-v-79a168f2>$(</span><span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>pwd</span><span class="token variable" data-v-79a168f2 data-v-79a168f2>)</span></span>/data"</span>:/srv/webapps/publican/data <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
       <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-v</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"<span class="token variable" data-v-79a168f2 data-v-79a168f2><span class="token variable" data-v-79a168f2 data-v-79a168f2>$(</span><span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>pwd</span><span class="token variable" data-v-79a168f2 data-v-79a168f2>)</span></span>/spec-data"</span>:/opt/bikeshed/bikeshed/spec-data <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
       <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-p</span> <span class="token number" data-v-79a168f2 data-v-79a168f2>7002</span>:7002 webspecs/publican:wip
</code></pre></div>
</li>
</ol>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>If you see the following, you're in the Docker container!!</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>webapps@2f33f5c6e183:~$
</code></pre></div>
<figure class="app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-init.png" alt="A terminal window with a few commands and a build process status and green lines, no errors" data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-init.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> 
  Launching the container
</figcaption></figure>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Initiate the empty shell we just created (it'll create stuff in the <code data-v-79a168f2 data-v-79a168f2>data/</code>
folder <em data-v-79a168f2 data-v-79a168f2>outside</em> of the container)</p>
</li>
</ul>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>publican.js init
</code></pre></div>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>It should look like the screenshot with caption "<em data-v-79a168f2 data-v-79a168f2>Launching the container</em>".</p>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Once done, exit the container. Notice that by doing this, you lose the state
of the VM and anything that has been written in the container. But, since we
use volumes (notice the <code data-v-79a168f2 data-v-79a168f2>-v /host/path:/container/path</code>), we actually wrote
<em data-v-79a168f2 data-v-79a168f2>outside</em> of the container.</p>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>We can <strong data-v-79a168f2 data-v-79a168f2>exit the container</strong></p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2> <span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>exit</span>
</code></pre></div>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>At this stage, we had publican and bikeshed to generate files (we may call
this a "cache warmup" of softs). Now, let's prepare the Vagrant VM to serve
the static content. Notice that the next commands are there only for the
purpose of a local workspace, in production this step will also be managed
automatically.</p>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Let's get back as the <strong data-v-79a168f2 data-v-79a168f2>root</strong> user, and create a quick web server;</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>exit</span>
<span class="token function" data-v-79a168f2 data-v-79a168f2>apt-get</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-yqq</span> <span class="token function" data-v-79a168f2 data-v-79a168f2>install</span>
nginx <span class="token function" data-v-79a168f2 data-v-79a168f2>mv</span> /vagrant/default.conf /etc/nginx/sites-available/default
<span class="token function" data-v-79a168f2 data-v-79a168f2>service</span> restart nginx
</code></pre></div>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Let's return back to <strong data-v-79a168f2 data-v-79a168f2>as the webapps user and launch the runner</strong></p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>su</span> webapps <span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>cd</span> /srv/webapps/publican/
</code></pre></div>
<figure class="app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-run-hook.png" alt="A terminal window with a build process status and green lines, no errors" data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-run-hook.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> 
Starting a build process
</figcaption></figure>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2><strong data-v-79a168f2 data-v-79a168f2>Starting a build process</strong>; this will also be managed automatically in
production.</p>
</li>
</ul>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-shell" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>docker</span> run <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-it</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>--rm</span> <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-v</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"<span class="token variable" data-v-79a168f2 data-v-79a168f2><span class="token variable" data-v-79a168f2 data-v-79a168f2>$(</span><span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>pwd</span><span class="token variable" data-v-79a168f2 data-v-79a168f2>)</span></span>/data"</span>:/srv/webapps/publican/data <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
           <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-v</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"<span class="token variable" data-v-79a168f2 data-v-79a168f2><span class="token variable" data-v-79a168f2 data-v-79a168f2>$(</span><span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>pwd</span><span class="token variable" data-v-79a168f2 data-v-79a168f2>)</span></span>/spec-data"</span>:/opt/bikeshed/bikeshed/spec-data <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
           <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-p</span> <span class="token number" data-v-79a168f2 data-v-79a168f2>7002</span>:7002 webspecs/publican:wip
</code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>It should look like the screenshot with caption "<em data-v-79a168f2 data-v-79a168f2>Starting a build process</em>".</p>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>get your Vagrant VM IP address</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>ifconfig</span>
</code></pre></div>
</li>
<li data-v-79a168f2 data-v-79a168f2>
<p data-v-79a168f2 data-v-79a168f2>Should start by <code data-v-79a168f2 data-v-79a168f2>172...</code> or <code data-v-79a168f2 data-v-79a168f2>192...</code>; visit a browser to that address</p>
</li>
</ul>
<h3 id="gists" data-v-79a168f2 data-v-79a168f2><a href="#gists" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Gists</h3>
<p data-v-79a168f2 data-v-79a168f2>Here are the files mentioned in this post</p>

<h4 id="configjson" data-v-79a168f2 data-v-79a168f2><a href="#configjson" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>config.json</h4>
<p data-v-79a168f2 data-v-79a168f2><a href="https://github.com/webspecs/publican" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Publican</a> expects this file as <code data-v-79a168f2 data-v-79a168f2>data/config.json</code>.</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-json" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>{</span>
  <span class="token property" data-v-79a168f2 data-v-79a168f2>"bikeshed"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"/opt/bikeshed/bikeshed.py"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
  <span class="token property" data-v-79a168f2 data-v-79a168f2>"rsyncPath"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"/srv/webapps/publican/"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
  <span class="token property" data-v-79a168f2 data-v-79a168f2>"python"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"python2"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
  <span class="token property" data-v-79a168f2 data-v-79a168f2>"logFile"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"logs/all.log"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
  <span class="token property" data-v-79a168f2 data-v-79a168f2>"email"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>{</span>
    <span class="token property" data-v-79a168f2 data-v-79a168f2>"to"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"jdoe@example.org"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
    <span class="token property" data-v-79a168f2 data-v-79a168f2>"from"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"jdoe@example.org"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
    <span class="token property" data-v-79a168f2 data-v-79a168f2>"host"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"localhost"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
    <span class="token property" data-v-79a168f2 data-v-79a168f2>"level"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"error"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
    <span class="token property" data-v-79a168f2 data-v-79a168f2>"handleExceptions"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token boolean" data-v-79a168f2 data-v-79a168f2>true</span>
  <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>}</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
  <span class="token property" data-v-79a168f2 data-v-79a168f2>"purgeAllURL"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"https://api.fastly.com/service/fooo/purge_all"</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>,</span>
  <span class="token property" data-v-79a168f2 data-v-79a168f2>"purgeAllKey"</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>:</span> <span class="token string" data-v-79a168f2 data-v-79a168f2>"baar"</span>
<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>}</span>
</code></pre></div>
<h4 id="defaultconf" data-v-79a168f2 data-v-79a168f2><a href="#defaultconf" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>default.conf</h4>
<p data-v-79a168f2 data-v-79a168f2>A minimal NGINX web server digging for static content that Publican generates.</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-nginx" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token comment" data-v-79a168f2 data-v-79a168f2># file: /etc/nginx/sites-enabled/default</span>
<span class="token directive" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>server</span></span> <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>{</span>
  <span class="token directive" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>listen</span> <span class="token number" data-v-79a168f2 data-v-79a168f2>80</span> default_server</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>;</span>
  <span class="token directive" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>root</span> /srv/webapps/publican/data/publish</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>;</span>
  <span class="token directive" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>index</span> index.html index.htm</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>;</span>
  <span class="token directive" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>server_name</span> localhost</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>;</span>
  <span class="token directive" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>location</span> /</span> <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>{</span> <span class="token directive" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>try_files</span> <span class="token variable" data-v-79a168f2 data-v-79a168f2>$uri</span> <span class="token variable" data-v-79a168f2 data-v-79a168f2>$uri</span>/ =404</span><span class="token punctuation" data-v-79a168f2 data-v-79a168f2>;</span> <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>}</span>
<span class="token punctuation" data-v-79a168f2 data-v-79a168f2>}</span>
</code></pre></div>
<h5 id="dockerfile" data-v-79a168f2 data-v-79a168f2><a href="#dockerfile" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Dockerfile</h5>
<p data-v-79a168f2 data-v-79a168f2>Here is the project's Dockerfile I created. I think it should be smaller, but
Publican works with the following script.</p>
<p data-v-79a168f2 data-v-79a168f2>Each step in a Dockerfile creates a "commit", make sure you have as few of them
as possible, and also make sure that you clean after yourself. Remember that a
Docker container is re-deployable and smallest the size of the container, the
better!</p>
<p data-v-79a168f2 data-v-79a168f2>Notice a few details;</p>
<ul data-v-79a168f2 data-v-79a168f2>
<li data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>ENV DEBIAN_FRONTEND=noninteractive</code> helps with dialogs</li>
<li data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>USER webapps</code> tells "where" the rest of the script will make commands as a
different user than root. Make sure what's required by root to be done before!</li>
<li data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2>COPY ...</code> this is basically how you import content inside the container (i.e.
make the container heavier)</li>
</ul>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-dockerfile" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token comment" data-v-79a168f2 data-v-79a168f2>#</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2># Publican Docker runner</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2>#</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2># See also:</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2>#   * https://github.com/nodesource/docker-node/blob/master/ubuntu/trusty/node/0.10.36/Dockerfile</span>

<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>FROM</span> nodesource/trusty:0.10.36</span>

<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>MAINTAINER</span> Renoir Boulanger &lt;renoir@w3.org></span>

<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>ENV</span> DEBIAN_FRONTEND=noninteractive</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Dependencies: Bikeshed, PhantomJS, Bikshed‚Äôs lxml</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>RUN</span> apt-get update && apt-get -y upgrade && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    apt-get install -yqq git python2.7 python-dev python-pip libxslt1-dev libxml2-dev zlib1g-dev && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    apt-get install -yqq libfontconfig1 libfreetype6 curl && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    apt-get autoremove -yqq --purge && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    pip install --upgrade lxml</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Copy everything we have locally into the container</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2># REMINDER: Make sure you run `make clone-bikeshed`, we prefer to keep a copy locally outside</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2># of the data volume. Otherwise it would make problems saying that bikeshed clone is not in the</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2># same filesystem.</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>COPY</span> . /srv/webapps/publican/</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Make sure we have a "non root" user and</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2># delete any local workbench data/ directory</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>RUN</span> /usr/sbin/groupadd --system --gid 990 webapps && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    /usr/sbin/useradd --system --gid 990 --uid 990 -G sudo --home-dir /srv/webapps --shell /bin/bash webapps && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    sed -i <span class="token string" data-v-79a168f2 data-v-79a168f2>'/^%sudo/d'</span> /etc/sudoers && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    echo <span class="token string" data-v-79a168f2 data-v-79a168f2>'%sudo ALL=NOPASSWD: ALL'</span> >> /etc/sudoers && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    mv /srv/webapps/publican/bikeshed /opt && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    rm -rf data && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    mkdir -p data/temp && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    rm -rf Dockerfile Makefile .git .gitignore DOCKER.md && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    chown -R webapps:webapps /srv/webapps/publican && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    chown -R webapps:webapps /opt/bikeshed</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Switch from root to webapps system user</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2># It **HAS to be** the SAME uid/gid as the owner on the host from which we‚Äôll use as volume</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>USER</span> webapps</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Where the session will start from</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>WORKDIR</span> /srv/webapps/publican</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Environment variables</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>ENV</span> PATH /srv/webapps/publican/node_modules/.bin:/srv/webapps/publican/bin:/srv/webapps/publican/.local/bin:<span class="token variable" data-v-79a168f2 data-v-79a168f2>$PATH</span></span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>ENV</span> HOME /srv/webapps/publican</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>ENV</span> TMPDIR /srv/webapps/publican/data/temp</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>ENV</span> NODE_ENV production</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>ENV</span> GIT_DISCOVERY_ACROSS_FILESYSTEM true</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Run what `make deps` would do</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>RUN</span> pip install --upgrade --user --editable /opt/bikeshed && <span class="token operator" data-v-79a168f2 data-v-79a168f2>\</span>
    mkdir -p node_modules && npm install</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Declare which port we expect to expose</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>EXPOSE</span> 7002</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Allow cli entry for debug, but make sure docker-compose.yml uses "command: bin/run.sh"</span>
<span class="token instruction" data-v-79a168f2 data-v-79a168f2><span class="token keyword" data-v-79a168f2 data-v-79a168f2>ENTRYPOINT</span> [<span class="token string" data-v-79a168f2 data-v-79a168f2>"/bin/bash"</span>]</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Note leftover: Ideally, it should exclusively run</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2>#ENTRYPOINT ["/bin/bash", "/srv/webapps/publican/bin/run.sh"]</span>

<span class="token comment" data-v-79a168f2 data-v-79a168f2># Note leftover: What it ends up doing</span>
<span class="token comment" data-v-79a168f2 data-v-79a168f2>#CMD ["node_modules/forever/bin/forever", "--fifo", "logs", "0"]</span>
</code></pre></div>
<h4 id="forever-start-script" data-v-79a168f2 data-v-79a168f2><a href="#forever-start-script" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Forever start script</h4>
<p data-v-79a168f2 data-v-79a168f2>If you notice in the Docker run command, I call a file <code data-v-79a168f2 data-v-79a168f2>bin/run.sh</code>, here it is.</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token function" data-v-79a168f2 data-v-79a168f2>docker</span> run <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-it</span> <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
       <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>--rm</span> <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
       <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>-p</span> <span class="token number" data-v-79a168f2 data-v-79a168f2>7002</span>:7002 <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
       webspecs/publican:latest <span class="token punctuation" data-v-79a168f2 data-v-79a168f2>\</span>
       bin/run.sh
</code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>Publican runs its process using <a href="https://github.com/foreverjs/forever" rel="nofollow noopener noreferrer" target="_blank" data-v-79a168f2 data-v-79a168f2>Forever</a>. The objective of forever is to
keep a process to run at all times.</p>
<p data-v-79a168f2 data-v-79a168f2>While this isn't ideal for NodeJS services, in the present use-case of a Docker
container who has the only purpose to run a process; Forever apt for the job!</p>
<div class="nuxt-content-highlight" data-v-79a168f2 data-v-79a168f2><pre class="line-numbers language-bash" data-v-79a168f2 data-v-79a168f2><code data-v-79a168f2 data-v-79a168f2><span class="token shebang important" data-v-79a168f2 data-v-79a168f2>#!/bin/bash</span>
<span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>export</span> <span class="token assign-left variable" data-v-79a168f2 data-v-79a168f2>RUNDIR</span><span class="token operator" data-v-79a168f2 data-v-79a168f2>=</span><span class="token string" data-v-79a168f2 data-v-79a168f2>"/srv/webapps/publican"</span>
<span class="token builtin class-name" data-v-79a168f2 data-v-79a168f2>cd</span> <span class="token variable" data-v-79a168f2 data-v-79a168f2>$RUNDIR</span>
node_modules/forever/bin/forever start <span class="token variable" data-v-79a168f2 data-v-79a168f2>$RUNDIR</span>/bin/server.js
node_modules/forever/bin/forever <span class="token parameter variable" data-v-79a168f2 data-v-79a168f2>--fifo</span> logs <span class="token number" data-v-79a168f2 data-v-79a168f2>0</span>
</code></pre></div>
<p data-v-79a168f2 data-v-79a168f2>That‚Äôs it, it‚Äôs all I had.</p>
<h3 id="screenshots" data-v-79a168f2 data-v-79a168f2><a href="#screenshots" aria-hidden="true" tabindex="-1" data-v-79a168f2 data-v-79a168f2><span class="icon icon-link" data-v-79a168f2 data-v-79a168f2></span></a>Screenshots</h3>

<div class="thumbnails gallery flex flex-row flex-wrap" style="overflow:hidden;clear:both" data-v-79a168f2 data-v-79a168f2>
<figure class="w-1/3" class="app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-preview.png" alt="A W3C Specification preview where we can see on the left the specification, and on the right the source highlighting changes in the source" data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-preview.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> 
<p data-v-33ff8cb7 data-v-79a168f2>W3C Publican prototype build process helping with specification change tracking during review process</p>
</figcaption></figure>
<figure class="w-1/3" class="app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-deleted-spec-regeneration-question.png" alt="" data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-deleted-spec-regeneration-question.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> 
<p data-v-33ff8cb7 data-v-79a168f2>Annotated screenshot, when changing a file a hook is called and regenerates the specification</p>
</figcaption></figure>
</div>
<div class="thumbnails gallery flex flex-row flex-wrap" style="overflow:hidden;clear:both" data-v-79a168f2 data-v-79a168f2>
<figure class="w-1/3" class="app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-preview.png" alt="..." data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-preview.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> 
...
</figcaption></figure>
<figure class="w-1/3" class="app-image is-loading has-image" data-v-33ff8cb7 data-v-79a168f2><img anonymous loading="lazy" src="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-deleted-spec-regeneration-question.png" alt="" data-remote="https://renoirb.github.io/site-assets/assets/content/blog/2015/05/publican-deleted-spec-regeneration-question.png" class="object-cover w-full rounded" data-v-33ff8cb7> <figcaption class="relative z-30 p-4 mt-2 text-sm rounded-md shadow-md" data-v-33ff8cb7><span class="figcaption-contents" data-v-33ff8cb7> </span> 
<p data-v-33ff8cb7 data-v-79a168f2>Annotated screenshot, when changing a file a hook is called and regenerates the specification</p>
</figcaption></figure>
</div></div> <div class="clearfix" data-v-79a168f2></div></div> <div class="text-md grid grid-cols-2 my-10" style="display:none" data-v-4d2003f9 data-v-79a168f2><div class="text-left" data-v-4d2003f9><a href="/blog/2015/05/make-discourse-long-polling-work-behind-fastly" lang="en-CA" class="hover:underline item-prev" data-v-4d2003f9>
      Make Discourse ‚Äúlong polling‚Äù work behind Fastly or Varnish
    </a></div> <div class="text-right" data-v-4d2003f9><a href="/blog/2015/05/converting-dynamic-site-static-copy" lang="en-CA" class="hover:underline item-next" data-v-4d2003f9>
      Converting a dynamic site into static HTML documents
    </a></div></div></div></div></div></div></div></div></section></div></main> <div timezone="America/New_York" class="app-footer--component disposition-parent w-full bottom" data-v-7116e49f><footer class="zone__sandwich__bottom container flex items-center justify-between p-10 mx-auto" style="position:relative" data-v-7116e49f><dl class="contact items-item disposition-item" data-v-7116e49f><dt class="mb-4 font-serif text-2xl" data-v-7116e49f><a href="/contact" class="underline" data-v-7116e49f>Contact</a></dt> <dd data-v-7116e49f>Fascinated By The Open Web Platform</dd> <dd aria-errormessage="why-fou-de-la-pouitte" data-v-7116e49f>
        Send your remarks using
        <em data-fou-de-la-pouitte title="Please type this manually" class="underline" data-v-7116e49f><span id="why-fou-de-la-pouitte" class="sr-only" data-v-7116e49f>
            An email address written using CSS, apologies for obfuscating
            this.
          </span></em></dd> <dd class="underline sr-only" data-v-7116e49f><a rel="me" href="https://mastodon.social/@renoirb" data-v-7116e49f>
          @renoirb@mastodon.social
        </a></dd> <dd class="underline sr-only" data-v-7116e49f><a rel="me" href="https://w3c.social/@renoirb" data-v-7116e49f>
          @renoirb@w3c.social
        </a></dd> <dd class="font-mono" data-v-7116e49f>v4.0.0-dev</dd> <span class="inline-flex" data-v-7116e49f><button aria-label="Color Mode" class="hover:text-primary-500 focus:outline-none transition duration-150 ease-in-out rounded-md"><!----> <!----></button></span></dl> <div class="items-item disposition-item" data-v-7116e49f><dl lang="fr-CA" class="see-also" data-v-7116e49f><dt data-v-7116e49f>Voir aussi‚Ä¶</dt> <dd data-v-7116e49f><a href="/ligne-editoriale" data-v-7116e49f> Ligne¬†√©ditoriale </a></dd> <dd data-v-7116e49f><a href="/projects" data-v-7116e49f> Projets </a></dd> <dd data-v-7116e49f><a href="/glossary" lang="en" data-v-7116e49f> Glossary </a></dd> <dd data-v-7116e49f><a href="/code-review" lang="en" data-v-7116e49f>
            Code-Review¬†notes
          </a></dd></dl></div></footer></div></div></div></div><script defer src="/_nuxt/static/1729799378/blog/2015/05/run-nodejs-process-forever-within-docker-container/state.js"></script><script src="/_nuxt/runtime.js" defer></script><script src="/_nuxt/pages/blog.js" defer></script><script src="/_nuxt/pages/blog/_year.js" defer></script><script src="/_nuxt/pages/blog/_year/_month.js" defer></script><script src="/_nuxt/pages/blog/_year/_month/_slug.js" defer></script><script src="/_nuxt/commons/app.js" defer></script><script src="/_nuxt/vendors/app.js" defer></script><script src="/_nuxt/app.js" defer></script><script data-n-head="ssr" type="module" vmid="load-esm-modules-separately-please" data-body="true" defer>
/**
 * #WIP-Mingle-CustomElements-From-ESM-Modules: Added on 2024-09-18 during migration.
 */
import { registerCustomElement } from 'https://renoirb.com/esm-modules/element-utils.mjs'
import NoticeBoxElement from 'https://renoirb.com/esm-modules/notice-box-element.mjs'
try {
  registerCustomElement(window, 'rb-notice-box', NoticeBoxElement)
} catch (e) {
  // #XXX FIX ME because this gets loaded
  console.log('Already loaded', e)
}
        </script>
  </body>
</html>
